// Scrybe Solutions - Database Schema
// Version 2.0 - January 2026

generator client {
  provider        = "prisma-client-js"
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  directUrl  = env("DIRECT_URL")
}

// ============================================
// ENUMS
// ============================================

enum Tier {
  FREE
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

enum FormType {
  INTAKE
  FOLLOWUP
  REFERRAL
  ASSESSMENT
  CUSTOM
}

enum FormStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum FieldType {
  TEXT_SHORT
  TEXT_LONG
  NUMBER
  DATE
  PHONE
  EMAIL
  ADDRESS
  DROPDOWN
  CHECKBOX
  YES_NO
  FILE
  SIGNATURE
}

enum FieldPurpose {
  GRANT_REQUIREMENT
  INTERNAL_OPS
  COMPLIANCE
  OUTCOME_MEASUREMENT
  RISK_ASSESSMENT
  OTHER
}

enum GranteeType {
  TEAM
  USER
}

enum FormRole {
  VIEW
  USE
  EDIT
}

// AuditAction is now a string field for flexibility

enum ScanStatus {
  PENDING
  SCANNING
  CLEAN
  INFECTED
  ERROR
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  PROGRAM_MANAGER
  CASE_MANAGER
  VIEWER
}

// ============================================
// CLIENT & CALL ENUMS (Spec-2)
// ============================================

enum ClientStatus {
  ACTIVE
  ON_HOLD
  CLOSED
  PENDING
}

enum CallStatus {
  INITIATING
  RINGING
  IN_PROGRESS
  COMPLETED
  ABANDONED
  ATTEMPTED
  FAILED
}

enum ProcessingStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  QUEUED_FOR_RETRY
}

enum NoteType {
  INTERNAL
  SHAREABLE
}

enum ConsentMode {
  AUTO_RECORDING
  CASE_MANAGER_SCRIPT
  DISABLED
}

enum PhoneNumberRequestStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}

// ============================================
// PROGRAM MANAGEMENT ENUMS
// ============================================

enum ProgramStatus {
  DRAFT
  ACTIVE
  COMPLETED
  CANCELLED
  ARCHIVED
}

enum ProgramLabelType {
  PROGRAM
  COURSE
  CLASS
  WORKSHOP
  TRAINING
  GROUP
}

enum EnrollmentStatus {
  ENROLLED
  IN_PROGRESS
  COMPLETED
  WITHDRAWN
  FAILED
  ON_HOLD
}

enum MaterialType {
  SYLLABUS
  HANDOUT
  PRESENTATION
  WORKSHEET
  ASSESSMENT
  CERTIFICATE_TEMPLATE
  OTHER
}

enum ExtractionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// ============================================
// ATTENDANCE TRACKING ENUMS
// ============================================

enum AttendanceUploadStatus {
  SHEET_GENERATED
  IN_PROGRESS
  PHOTO_UPLOADED
  AI_PROCESSING
  PENDING_REVIEW
  CONFIRMED
  FAILED
  PENDING_OVERRIDE_REVIEW
}

enum AttendanceType {
  PRESENT
  EXCUSED
  ABSENT
}

// ============================================
// ORGANIZATION & USERS
// ============================================

model Organization {
  id                    String      @id @default(uuid())
  name                  String
  slug                  String      @unique
  tier                  Tier        @default(FREE)
  purchasedFormPacks    Int         @default(0)
  encryptionKeyId       String?
  webhookUrl            String?

  // Settings
  settings              Json        @default("{}")

  // Feature flags for new features
  featureFlags          Json        @default("{}")

  // User limits by tier (FREE=3, STARTER=10, PROFESSIONAL=50, ENTERPRISE=unlimited)
  userLimit             Int         @default(3)

  // VOIP Settings (Spec-2)
  preferredAreaCode     String?
  recordingRetentionDays Int        @default(30)
  consentMode           ConsentMode @default(CASE_MANAGER_SCRIPT)
  consentRecordingUrl   String?

  // Billing
  stripeCustomerId      String?     @unique

  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt

  // Relations
  users                 User[]
  teams                 Team[]
  forms                 Form[]
  formTemplates         FormTemplate[]
  auditLogs             AuditLog[]
  fileUploads           FileUpload[]
  clients               Client[]
  phoneNumberPool       PhoneNumberPool[]
  phoneNumberRequests   PhoneNumberRequest[]
  userInvitations       UserInvitation[]
  programs              Program[]

  // Messaging Relations (Spec-3)
  messages              Message[]
  smsTemplates          SmsTemplate[]

  // Job Infrastructure Relations
  jobProgress           JobProgress[]
  noteTemplates         NoteTemplate[]

  // Form Conversion Relations
  formConversions       FormConversion[]

  // Automated Reporting Relations (Phase 4)
  reportTemplates       ReportTemplate[]
  reports               Report[]
  customMetrics         CustomMetric[]

  @@index([slug])
  @@index([stripeCustomerId])
}

model User {
  id              String   @id @default(uuid())
  orgId           String
  email           String   @unique
  name            String?
  avatarUrl       String?
  role            UserRole @default(CASE_MANAGER)

  // Supabase Auth
  supabaseUserId  String   @unique

  // Permissions (CRUD split for forms)
  canCreateForms  Boolean  @default(false)
  canReadForms    Boolean  @default(true)
  canUpdateForms  Boolean  @default(false)
  canDeleteForms  Boolean  @default(false)
  canPublishForms Boolean  @default(false)

  // Caseload (Spec-2)
  maxCaseload     Int?

  isActive        Boolean  @default(true)
  lastLoginAt     DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  organization    Organization   @relation(fields: [orgId], references: [id], onDelete: Cascade)
  teamMemberships TeamMember[]
  createdForms    Form[]         @relation("FormCreator")
  formVersions    FormVersion[]
  formAccess      FormAccess[]   @relation("AccessGranter")

  // Client & Call Relations (Spec-2)
  assignedClients Client[]       @relation("AssignedClients")
  createdClients  Client[]       @relation("CreatedClients")
  calls           Call[]
  notes           Note[]
  twilioNumber    TwilioNumber?
  formSubmissions FormSubmission[]
  formEditLogs    FormEditLog[]

  // Phone Number Request Relations
  phoneRequests         PhoneNumberRequest[] @relation("PhoneRequests")
  resolvedPhoneRequests PhoneNumberRequest[] @relation("ResolvedRequests")

  // User Invitation Relations
  invitationsSent       UserInvitation[]     @relation("InvitedBy")

  // Deactivation tracking
  deactivatedAt         DateTime?
  deactivatedById       String?

  // Program Relations
  facilitatedPrograms   Program[]            @relation("ProgramFacilitator")
  createdPrograms       Program[]            @relation("ProgramCreator")
  enrolledClients       ProgramEnrollment[]  @relation("EnrolledBy")
  recordedAttendance    SessionAttendance[]  @relation("AttendanceRecordedBy")
  uploadedMaterials     ProgramMaterial[]    @relation("MaterialUploadedBy")

  // Attendance Upload Relations
  attendanceUploads         AttendanceUpload[]          @relation("AttendanceUploadedBy")
  attendanceReviews         AttendanceUpload[]          @relation("AttendanceReviewedBy")
  attendanceOverrides       AttendanceUpload[]          @relation("AttendanceOverrideApprovedBy")
  attendanceVerifications   AttendanceExtractedRecord[] @relation("AttendanceManuallyVerifiedBy")

  // Messaging Relations (Spec-3)
  sentMessages          Message[]            @relation("MessageSender")

  // Job Infrastructure Relations
  jobProgress           JobProgress[]
  notifications         Notification[]

  // Note Template Relations
  ownedNoteTemplates    NoteTemplate[]       @relation("NoteTemplateOwner")
  createdNoteTemplates  NoteTemplate[]       @relation("NoteTemplateCreator")

  // Form Conversion Relations
  formConversions       FormConversion[]

  // Automated Reporting Relations (Phase 4)
  createdReportTemplates  ReportTemplate[]       @relation("ReportTemplateCreator")
  publishedReportTemplates ReportTemplate[]      @relation("ReportTemplatePublisher")
  generatedReports        Report[]
  customMetrics           CustomMetric[]
  curatedFunderDocs       FunderDocumentLibrary[]

  @@index([orgId])
  @@index([email])
  @@index([supabaseUserId])
}

model Team {
  id          String   @id @default(uuid())
  orgId       String
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  organization Organization  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  members      TeamMember[]
  formAccess   FormAccess[]

  @@unique([orgId, name])
  @@index([orgId])
}

model TeamMember {
  id        String   @id @default(uuid())
  teamId    String
  userId    String
  createdAt DateTime @default(now())

  // Relations
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
}

// ============================================
// FORMS & FIELDS
// ============================================

model Form {
  id          String     @id @default(uuid())
  orgId       String
  name        String
  description String?
  type        FormType
  status      FormStatus @default(DRAFT)
  version     Int        @default(1)

  // Settings (JSON for flexibility)
  settings    Json       @default("{\"allowPartialSaves\": true, \"requireSupervisorReview\": false, \"autoArchiveDays\": null, \"activityTriggers\": []}")

  // Form conversion fingerprint for duplicate detection
  fieldFingerprint String?

  createdById String
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  archivedAt  DateTime?
  publishedAt DateTime?

  // Relations
  organization Organization    @relation(fields: [orgId], references: [id], onDelete: Cascade)
  createdBy    User            @relation("FormCreator", fields: [createdById], references: [id])
  fields       FormField[]
  versions     FormVersion[]
  access       FormAccess[]
  submissions  FormSubmission[]
  conversions  FormConversion[]

  @@index([orgId, status])
  @@index([createdById])
  @@index([status])
  @@index([orgId, fieldFingerprint])
}

model FormField {
  id               String       @id @default(uuid())
  formId           String
  slug             String
  name             String
  type             FieldType
  purpose          FieldPurpose
  purposeNote      String?
  helpText         String?

  isRequired       Boolean      @default(false)
  isSensitive      Boolean      @default(false)
  isAiExtractable  Boolean      @default(true)

  // For dropdown/checkbox - array of options
  options          Json?

  // Grouping
  section          String?
  order            Int          @default(0)

  // Conditional logic (React Flow compatible)
  conditionalLogic Json?

  // i18n translations
  translations     Json?

  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  // Relations
  form               Form                @relation(fields: [formId], references: [id], onDelete: Cascade)
  extractionExamples ExtractionExample[]

  @@unique([formId, slug])
  @@index([formId, order])
}

model FormVersion {
  id                  String   @id @default(uuid())
  formId              String
  version             Int
  snapshot            Json
  aiExtractionPrompt  String   @db.Text
  publishedById       String
  publishedAt         DateTime @default(now())

  // Relations
  form        Form             @relation(fields: [formId], references: [id], onDelete: Cascade)
  publishedBy User             @relation(fields: [publishedById], references: [id])
  submissions FormSubmission[]

  @@unique([formId, version])
  @@index([formId])
}

model FormAccess {
  id          String      @id @default(uuid())
  formId      String
  granteeType GranteeType
  granteeId   String
  role        FormRole
  grantedById String
  grantedAt   DateTime    @default(now())

  // Relations
  form      Form  @relation(fields: [formId], references: [id], onDelete: Cascade)
  grantedBy User  @relation("AccessGranter", fields: [grantedById], references: [id])
  team      Team? @relation(fields: [granteeId], references: [id], map: "FormAccess_team_fkey")

  @@unique([formId, granteeType, granteeId])
  @@index([formId])
  @@index([granteeId])
}

// ============================================
// AI EXTRACTION
// ============================================

model ExtractionExample {
  id                String                         @id @default(uuid())
  fieldId           String
  transcriptSnippet String                         @db.Text
  extractedValue    String
  // embedding      Unsupported("vector(1536)")?   // TODO: Re-enable when pgvector is installed
  createdById       String
  createdAt         DateTime                       @default(now())

  // Relations
  field FormField @relation(fields: [fieldId], references: [id], onDelete: Cascade)

  @@index([fieldId])
}

// ============================================
// TEMPLATES
// ============================================

model FormTemplate {
  id               String   @id @default(uuid())
  orgId            String?
  name             String
  description      String?
  tags             String[]
  thumbnail        String?
  useCaseExamples  String[]
  formSnapshot     Json
  isSystemTemplate Boolean  @default(false)
  createdById      String
  createdAt        DateTime @default(now())
  usageCount       Int      @default(0)

  // Relations
  organization Organization? @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([isSystemTemplate])
  @@index([orgId])
}

// ============================================
// SUBMISSIONS
// ============================================

model FormSubmission {
  id              String    @id @default(uuid())
  orgId           String
  formId          String
  formVersionId   String
  clientId        String?
  callId          String?

  // Submission data (encrypted sensitive fields)
  data            Json

  // Status tracking
  status          String    @default("DRAFT") // DRAFT, SUBMITTED, APPROVED, REJECTED
  isComplete      Boolean   @default(false)
  isDraft         Boolean   @default(true)

  // AI extraction metadata
  aiExtractedData Json?
  aiConfidence    Json?
  flaggedFields   String[]  @default([])

  submittedById   String?
  submittedAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  form        Form        @relation(fields: [formId], references: [id], onDelete: Cascade)
  formVersion FormVersion @relation(fields: [formVersionId], references: [id])
  signatures  Signature[]
  client      Client?     @relation(fields: [clientId], references: [id])
  call        Call?       @relation(fields: [callId], references: [id])
  submitter   User?       @relation(fields: [submittedById], references: [id])
  editLogs    FormEditLog[]

  @@index([formId])
  @@index([formVersionId])
  @@index([clientId])
  @@index([callId])
}

model Signature {
  id                String   @id @default(uuid())
  submissionId      String
  fieldId           String
  imageData         Bytes
  imageHash         String
  timestamp         DateTime @default(now())
  signerIp          String
  signerUserAgent   String
  signerSessionId   String
  geolocation       Json?
  deviceFingerprint String?
  consentRecorded   Boolean  @default(true)
  consentText       String?
  documentHash      String?

  // Relations
  submission FormSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@index([submissionId])
}

// ============================================
// FILE HANDLING
// ============================================

model FileUpload {
  id            String     @id @default(uuid())
  orgId         String
  originalName  String
  storagePath   String
  mimeType      String
  sizeBytes     Int
  scanStatus    ScanStatus @default(PENDING)
  scanResult    Json?
  scannedAt     DateTime?
  extractedText String?    @db.Text
  uploadedById  String
  uploadedAt    DateTime   @default(now())

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([scanStatus])
}

// ============================================
// AUDIT & COMPLIANCE
// ============================================

model AuditLog {
  id           String   @id @default(uuid())
  orgId        String
  userId       String?
  action       String   // CREATE, UPDATE, DELETE, VIEW, EXPORT, PUBLISH, etc.
  resource     String   // FORM, SUBMISSION, CLIENT, USER, FILE, etc.
  resourceId   String
  resourceName String?
  details      Json     @default("{}")
  ipAddress    String?
  userAgent    String?

  // Hash chain for immutability
  previousHash String
  hash         String

  timestamp    DateTime @default(now())

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId, timestamp])
  @@index([resource, resourceId])
  @@index([userId])
  @@index([action])
}

model ComplianceReport {
  id            String   @id @default(uuid())
  orgId         String
  reportType    String   // ACTIVITY_SUMMARY, DATA_ACCESS, USER_ACTIVITY, etc.
  startDate     DateTime
  endDate       DateTime
  generatedAt   DateTime @default(now())
  generatedById String
  data          Json
  hash          String   // For integrity verification

  @@index([orgId, reportType])
  @@index([orgId, generatedAt])
}

// ============================================
// BILLING & SUBSCRIPTIONS
// ============================================

model Subscription {
  id                   String   @id @default(uuid())
  orgId                String
  stripeSubscriptionId String   @unique
  stripeCustomerId     String
  tier                 String   // FREE, STARTER, PROFESSIONAL, ENTERPRISE
  status               String   // active, past_due, canceled, etc.
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  cancelAtPeriodEnd    Boolean  @default(false)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@index([orgId])
  @@index([stripeCustomerId])
  @@index([status])
}

model PaymentHistory {
  id               String   @id @default(uuid())
  orgId            String
  stripePaymentId  String   @unique
  amount           Int      // Amount in cents
  currency         String   @default("usd")
  status           String   // succeeded, pending, failed
  description      String?
  type             String   // subscription, form_pack, etc.
  metadata         Json?
  createdAt        DateTime @default(now())

  @@index([orgId])
  @@index([createdAt])
}

// ============================================
// CLIENT MANAGEMENT (Spec-2)
// ============================================

model Client {
  id               String       @id @default(uuid())
  orgId            String
  firstName        String
  lastName         String
  phone            String       // Primary phone (10 digits)
  additionalPhones Json?        // Array of { number, label }
  email            String?
  address          Json?        // { street, city, state, zip, formatted, coordinates }
  internalId       String?      // Org-specific ID for external system sync
  status           ClientStatus @default(ACTIVE)
  assignedTo       String       // Case manager user ID
  createdBy        String
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  deletedAt        DateTime?    // Soft delete

  // Relations
  organization        Organization        @relation(fields: [orgId], references: [id], onDelete: Cascade)
  assignedUser        User                @relation("AssignedClients", fields: [assignedTo], references: [id])
  creator             User                @relation("CreatedClients", fields: [createdBy], references: [id])
  calls               Call[]
  notes               Note[]
  formSubmissions     FormSubmission[]
  programEnrollments  ProgramEnrollment[]

  // Messaging Relations (Spec-3)
  messages            Message[]
  smsPreference       SmsPreference?
  portalTokens        PortalToken[]

  // Portal Session Relations
  portalSessions      PortalSession[]
  clientPIN           ClientPIN?
  phoneVerifications  PhoneVerification[]

  @@index([orgId, status])
  @@index([orgId, phone])
  @@index([assignedTo])
}

// ============================================
// CALL MANAGEMENT (Spec-2)
// ============================================

model Call {
  id                  String           @id @default(uuid())
  clientId            String
  caseManagerId       String
  formIds             String[]         // Forms selected for this call
  status              CallStatus       @default(INITIATING)
  startedAt           DateTime
  endedAt             DateTime?
  durationSeconds     Int?

  // Recording
  twilioCallSid       String?          @unique
  recordingUrl        String?          // S3 URL
  recordingRetention  DateTime?        // When to delete based on org policy

  // Transcript
  transcriptRaw       String?          @db.Text
  transcriptJson      Json?            // Array of TranscriptSegment

  // AI Processing
  aiSummary           Json?            // CallSummary structure
  extractedFields     Json?            // Field slug -> value
  confidenceScores    Json?            // Field slug -> ExtractionConfidence
  manualCorrections   Json?            // Array of FieldCorrection

  // Queue for retry
  aiProcessingStatus  ProcessingStatus @default(PENDING)
  aiProcessingError   String?
  aiProcessingRetries Int              @default(0)

  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt

  // Relations
  client              Client           @relation(fields: [clientId], references: [id])
  caseManager         User             @relation(fields: [caseManagerId], references: [id])
  notes               Note[]
  formSubmissions     FormSubmission[]

  @@index([clientId])
  @@index([caseManagerId])
  @@index([status])
  @@index([aiProcessingStatus])
}

// ============================================
// NOTES (Spec-2)
// ============================================

model Note {
  id         String    @id @default(uuid())
  clientId   String
  callId     String?   // Optional link to call
  sessionId  String?   // Optional link to program session (for mass notes)
  authorId   String
  type       NoteType  @default(INTERNAL)
  content    String    @db.Text // Rich text HTML, max 10000 chars
  tags       String[]  // Flexible tagging
  isMassNote Boolean   @default(false) // Flag for mass-created notes
  isDraft    Boolean   @default(false)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deletedAt  DateTime? // Soft delete

  // Relations
  client    Client          @relation(fields: [clientId], references: [id])
  call      Call?           @relation(fields: [callId], references: [id])
  session   ProgramSession? @relation(fields: [sessionId], references: [id])
  author    User            @relation(fields: [authorId], references: [id])

  @@index([clientId])
  @@index([callId])
  @@index([sessionId])
  @@index([authorId])
}

// ============================================
// TWILIO PHONE NUMBERS (Spec-2)
// ============================================

model TwilioNumber {
  id            String   @id @default(uuid())
  userId        String   @unique
  phoneNumber   String   @unique // E.164 format
  twilioSid     String   @unique
  areaCode      String   // For org preference tracking
  provisionedAt DateTime @default(now())

  // Relations
  user          User     @relation(fields: [userId], references: [id])
}

// ============================================
// PHONE NUMBER POOL (Admin-managed numbers)
// ============================================

model PhoneNumberPool {
  id            String   @id @default(uuid())
  orgId         String
  phoneNumber   String   @unique // E.164 format
  twilioSid     String   @unique
  areaCode      String
  purchasedAt   DateTime @default(now())
  monthlyCost   Decimal  @default(5.00) @db.Decimal(10, 2)

  // Relations
  organization  Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
}

// ============================================
// PHONE NUMBER REQUESTS (Case manager requests)
// ============================================

model PhoneNumberRequest {
  id              String                   @id @default(uuid())
  userId          String
  orgId           String
  status          PhoneNumberRequestStatus @default(PENDING)
  requestedAt     DateTime                 @default(now())
  resolvedAt      DateTime?
  resolvedBy      String?
  rejectionReason String?

  // Relations
  user            User         @relation("PhoneRequests", fields: [userId], references: [id])
  organization    Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  resolver        User?        @relation("ResolvedRequests", fields: [resolvedBy], references: [id])

  @@index([orgId, status])
  @@index([userId])
}

// ============================================
// FORM EDIT LOGS (Spec-2)
// ============================================

model FormEditLog {
  id            String   @id @default(uuid())
  submissionId  String
  fieldId       String
  previousValue Json?
  newValue      Json?
  editedBy      String
  editedAt      DateTime @default(now())
  editReason    String?

  // Relations
  submission    FormSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  editor        User           @relation(fields: [editedBy], references: [id])

  @@index([submissionId])
  @@index([editedBy])
}

// ============================================
// RESOURCE LOCKING (Spec-2)
// ============================================

model ResourceLock {
  id           String   @id @default(uuid())
  resourceType String   // 'form_submission', 'client', etc.
  resourceId   String
  lockedBy     String   // User ID
  lockedAt     DateTime @default(now())
  expiresAt    DateTime // Auto-expire after 5 minutes of inactivity

  @@unique([resourceType, resourceId])
  @@index([expiresAt])
}

// ============================================
// USER INVITATIONS
// ============================================

model UserInvitation {
  id              String           @id @default(uuid())
  email           String
  name            String
  role            UserRole
  teamId          String?
  maxCaseload     Int?

  // Invitation token and status
  token           String           @unique
  status          InvitationStatus @default(PENDING)
  expiresAt       DateTime

  // Tracking timestamps
  acceptedAt      DateTime?
  revokedAt       DateTime?
  reminderSentAt  DateTime?

  // Who sent the invitation
  invitedById     String
  invitedBy       User             @relation("InvitedBy", fields: [invitedById], references: [id])

  // Organization
  orgId           String
  organization    Organization     @relation(fields: [orgId], references: [id], onDelete: Cascade)

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@index([orgId])
  @@index([token])
  @@index([email, orgId])
  @@index([status])
}

// ============================================
// PROGRAM MANAGEMENT
// ============================================

model Program {
  id              String           @id @default(uuid())
  orgId           String
  name            String
  labelType       ProgramLabelType @default(PROGRAM)
  description     String?          @db.Text
  requiredHours   Int?             // Total hours needed for completion
  startDate       DateTime?
  endDate         DateTime?
  schedule        Json?            // Flexible schedule info (e.g., days of week, time, frequency)
  location        String?
  maxEnrollment   Int?             // Maximum number of participants
  facilitatorId   String?
  status          ProgramStatus    @default(DRAFT)
  createdById     String
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  archivedAt      DateTime?

  // Relations
  organization          Organization           @relation(fields: [orgId], references: [id], onDelete: Cascade)
  facilitator           User?                  @relation("ProgramFacilitator", fields: [facilitatorId], references: [id])
  createdBy             User                   @relation("ProgramCreator", fields: [createdById], references: [id])
  sessions              ProgramSession[]
  enrollments           ProgramEnrollment[]
  materials             ProgramMaterial[]
  attendanceSheetConfig AttendanceSheetConfig?
  noteTemplates         NoteTemplate[]

  @@index([orgId, status])
  @@index([facilitatorId])
  @@index([createdById])
}

model ProgramSession {
  id              String   @id @default(uuid())
  programId       String
  sessionNumber   Int      // Order/sequence number
  title           String
  topic           String?  @db.Text
  date            DateTime?
  durationMinutes Int?
  notes           String?  @db.Text
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  program           Program             @relation(fields: [programId], references: [id], onDelete: Cascade)
  attendance        SessionAttendance[]
  materials         ProgramMaterial[]
  attendanceUploads AttendanceUpload[]
  massNotes         Note[]              // Mass notes for session

  @@unique([programId, sessionNumber])
  @@index([programId])
  @@index([date])
}

model ProgramEnrollment {
  id              String           @id @default(uuid())
  programId       String
  clientId        String
  enrolledDate    DateTime         @default(now())
  status          EnrollmentStatus @default(ENROLLED)
  hoursOverride   Decimal?         @db.Decimal(6, 2) // Manual override for completed hours
  completionDate  DateTime?
  withdrawalDate  DateTime?
  withdrawalReason String?
  enrolledById    String
  notes           String?          @db.Text
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  // Relations
  program           Program                     @relation(fields: [programId], references: [id], onDelete: Cascade)
  client            Client                      @relation(fields: [clientId], references: [id])
  enrolledBy        User                        @relation("EnrolledBy", fields: [enrolledById], references: [id])
  attendance        SessionAttendance[]
  attendanceCode    AttendanceCode?
  extractedRecords  AttendanceExtractedRecord[]

  @@unique([programId, clientId])
  @@index([programId, status])
  @@index([clientId])
  @@index([enrolledById])
}

model SessionAttendance {
  id              String          @id @default(uuid())
  sessionId       String
  enrollmentId    String
  attended        Boolean         @default(false)
  hoursAttended   Decimal?        @db.Decimal(4, 2) // Actual hours (can differ from session duration)
  notes           String?
  recordedById    String
  recordedAt      DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Extended fields for photo-based attendance tracking
  attendanceType  AttendanceType? // PRESENT, EXCUSED, ABSENT
  uploadSourceId  String?         // Link to AttendanceUpload
  timeIn          DateTime?
  timeOut         DateTime?
  signatureVerified Boolean       @default(false)

  // Relations
  session         ProgramSession    @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  enrollment      ProgramEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  recordedBy      User              @relation("AttendanceRecordedBy", fields: [recordedById], references: [id])

  @@unique([sessionId, enrollmentId])
  @@index([sessionId])
  @@index([enrollmentId])
  @@index([uploadSourceId])
}

model ProgramMaterial {
  id               String           @id @default(uuid())
  programId        String
  sessionId        String?          // Optional - can be program-level or session-specific
  filename         String
  fileUrl          String           // S3 URL
  mimeType         String
  sizeBytes        Int
  materialType     MaterialType     @default(OTHER)
  extractionStatus ExtractionStatus @default(PENDING)
  extractedData    Json?            // AI-extracted syllabus data
  extractionError  String?
  uploadedById     String
  uploadedAt       DateTime         @default(now())

  // Relations
  program          Program         @relation(fields: [programId], references: [id], onDelete: Cascade)
  session          ProgramSession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)
  uploadedBy       User            @relation("MaterialUploadedBy", fields: [uploadedById], references: [id])

  @@index([programId])
  @@index([sessionId])
  @@index([materialType])
  @@index([extractionStatus])
}

// ============================================
// ATTENDANCE TRACKING (Photo-based AI Recognition)
// ============================================

model AttendanceSheetConfig {
  id                     String   @id @default(uuid())
  programId              String   @unique
  includeTimeInOut       Boolean  @default(true)
  includeClientSignature Boolean  @default(true)
  includeNotes           Boolean  @default(true)
  customInstructions     String?  @db.Text
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  // Relations
  program                Program  @relation(fields: [programId], references: [id], onDelete: Cascade)
}

model AttendanceCode {
  id           String   @id @default(uuid())
  enrollmentId String   @unique
  code         String   // Format: BK2847 (consonants + numbers)
  createdAt    DateTime @default(now())

  // Relations
  enrollment   ProgramEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)

  @@index([code])
}

model AttendanceUpload {
  id                    String                  @id @default(uuid())
  sessionId             String
  orgId                 String
  status                AttendanceUploadStatus  @default(SHEET_GENERATED)

  // Sheet generation tracking
  sheetPath             String?                 // S3 path to generated PDF
  sheetGeneratedAt      DateTime?

  // Photo upload tracking
  photoPath             String?                 // S3 path to uploaded photo
  photoUploadedAt       DateTime?
  photoMimeType         String?
  photoSizeBytes        Int?
  enhancedPhotoPath     String?                 // S3 path to enhanced photo

  // AI processing tracking
  aiProcessingStartedAt DateTime?
  aiProcessingEndedAt   DateTime?
  aiRawResponse         Json?
  aiExtractedData       Json?                   // Structured extraction results
  aiConfidence          Float?
  aiError               String?
  aiRetryCount          Int                     @default(0)

  // Review tracking
  reviewedAt            DateTime?
  reviewedById          String?
  reviewNotes           String?                 @db.Text

  // Override handling
  isOverride            Boolean                 @default(false)
  overrideReason        String?                 @db.Text
  overrideApprovedById  String?
  overrideApprovedAt    DateTime?

  // User tracking
  uploadedById          String

  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt

  // Relations
  session               ProgramSession          @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  uploadedBy            User                    @relation("AttendanceUploadedBy", fields: [uploadedById], references: [id])
  reviewedBy            User?                   @relation("AttendanceReviewedBy", fields: [reviewedById], references: [id])
  overrideApprovedBy    User?                   @relation("AttendanceOverrideApprovedBy", fields: [overrideApprovedById], references: [id])
  extractedRecords      AttendanceExtractedRecord[]

  @@index([sessionId])
  @@index([orgId, status])
  @@index([uploadedById])
  @@index([status])
}

model AttendanceExtractedRecord {
  id                   String          @id @default(uuid())
  uploadId             String
  enrollmentId         String?         // Nullable for walk-ins

  // Extracted data
  attendanceType       AttendanceType?
  qrCodeDetected       Boolean         @default(false)
  qrCodeValue          String?
  printedCodeDetected  Boolean         @default(false)
  printedCodeValue     String?
  timeIn               DateTime?
  timeOut              DateTime?
  signatureDetected    Boolean         @default(false)
  notes                String?         @db.Text

  // Confidence and review
  confidence           Float?
  needsReview          Boolean         @default(false)
  reviewFlag           String?         // Reason for flag (e.g., "low_confidence", "no_match", "missing_signature")

  // Manual verification
  isManuallyVerified   Boolean         @default(false)
  manuallyVerifiedById String?
  manuallyVerifiedAt   DateTime?

  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt

  // Relations
  upload               AttendanceUpload   @relation(fields: [uploadId], references: [id], onDelete: Cascade)
  enrollment           ProgramEnrollment? @relation(fields: [enrollmentId], references: [id])
  manuallyVerifiedBy   User?              @relation("AttendanceManuallyVerifiedBy", fields: [manuallyVerifiedById], references: [id])

  @@index([uploadId])
  @@index([enrollmentId])
}

model AttendanceUploadRateLimit {
  id         String   @id @default(uuid())
  userId     String
  sessionId  String
  uploadCount Int     @default(1)
  windowStart DateTime @default(now())

  @@unique([userId, sessionId])
  @@index([windowStart])
}

// ============================================
// SMS/MESSAGING SYSTEM (Spec-3)
// ============================================

enum MessageSenderType {
  CASE_MANAGER
  CLIENT
}

enum MessageStatus {
  DRAFT
  SENT
  DELIVERED
  READ
  FAILED
}

enum SmsDeliveryStatus {
  QUEUED
  SENT
  DELIVERED
  UNDELIVERED
  FAILED
}

model Message {
  id            String              @id @default(uuid())
  orgId         String
  clientId      String
  senderId      String?             // User ID (case manager) or null for client replies
  senderType    MessageSenderType
  content       String              @db.Text
  contentHash   String?             // SHA-256 for integrity verification
  status        MessageStatus       @default(SENT)
  sentAt        DateTime            @default(now())
  deliveredAt   DateTime?
  readAt        DateTime?
  expiresAt     DateTime?           // For 7-year retention policy
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  deletedAt     DateTime?           // Soft delete

  // Relations
  organization    Organization        @relation(fields: [orgId], references: [id], onDelete: Cascade)
  client          Client              @relation(fields: [clientId], references: [id])
  sender          User?               @relation("MessageSender", fields: [senderId], references: [id])
  attachments     MessageAttachment[]
  smsNotification SmsNotification?

  @@index([clientId, sentAt])
  @@index([orgId, clientId])
  @@index([senderId])
  @@index([status])
}

model MessageAttachment {
  id          String   @id @default(uuid())
  messageId   String
  filename    String
  fileUrl     String   // S3 URL (encrypted at rest with AES-256)
  mimeType    String
  fileSize    Int      // bytes
  uploadedAt  DateTime @default(now())

  message     Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
}

model SmsNotification {
  id              String              @id @default(uuid())
  messageId       String              @unique
  phoneNumber     String              // E.164 format
  twilioSid       String?             @unique
  deliveryStatus  SmsDeliveryStatus   @default(QUEUED)
  sentAt          DateTime?
  deliveredAt     DateTime?
  errorCode       String?
  errorMessage    String?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  message         Message             @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([twilioSid])
  @@index([deliveryStatus])
}

model SmsPreference {
  id            String    @id @default(uuid())
  clientId      String    @unique
  optedIn       Boolean   @default(false)
  phoneNumber   String    // E.164 format
  optedInAt     DateTime?
  optedOutAt    DateTime?
  optInMethod   String?   // "portal", "verbal", "written"
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  client        Client    @relation(fields: [clientId], references: [id])

  @@index([clientId])
}

model PortalToken {
  id          String    @id @default(uuid())
  clientId    String
  token       String    @unique
  messageId   String?   // Optional: link to specific message
  expiresAt   DateTime  // 24-hour expiry
  usedAt      DateTime?
  createdAt   DateTime  @default(now())

  client      Client    @relation(fields: [clientId], references: [id])

  @@index([token])
  @@index([clientId])
  @@index([expiresAt])
}

// Admin-configurable SMS templates (P1)
model SmsTemplate {
  id          String    @id @default(uuid())
  orgId       String
  name        String
  content     String    // Template with placeholders like {{portal_link}}
  isDefault   Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, name])
  @@index([orgId])
}

// ============================================
// CLIENT PORTAL SESSION MANAGEMENT
// ============================================

model PortalSession {
  id            String    @id @default(uuid())
  clientId      String
  sessionToken  String    @unique
  createdAt     DateTime  @default(now())
  expiresAt     DateTime
  ipAddress     String?
  userAgent     String?
  csrfToken     String

  client        Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([sessionToken])
  @@index([clientId])
  @@index([expiresAt])
}

model ClientPIN {
  id             String    @id @default(uuid())
  clientId       String    @unique
  pinHash        String
  failedAttempts Int       @default(0)
  lockedUntil    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  client         Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
}

model PhoneVerification {
  id          String    @id @default(uuid())
  clientId    String
  phoneNumber String
  codeHash    String
  sentAt      DateTime  @default(now())
  expiresAt   DateTime
  verifiedAt  DateTime?
  attempts    Int       @default(0)

  client      Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([expiresAt])
}

// ============================================
// JOB INFRASTRUCTURE (Phase 1)
// ============================================

enum JobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

model JobProgress {
  id        String    @id @default(uuid())
  type      String    // mass-note-batch, form-conversion, report-generation
  userId    String
  orgId     String
  status    JobStatus @default(PENDING)
  progress  Int       @default(0)
  total     Int       @default(0)
  completed Int       @default(0)
  failed    Int       @default(0)
  result    Json?
  error     String?
  metadata  Json?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  user         User         @relation(fields: [userId], references: [id])
  organization Organization @relation(fields: [orgId], references: [id])

  @@index([userId, status])
  @@index([orgId, type])
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  type      String
  title     String
  message   String
  metadata  Json?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId, read])
}

// ============================================
// NOTE TEMPLATES (Phase 2 - Mass Notes)
// ============================================

enum NoteTemplateScope {
  ORG
  PROGRAM
  USER
}

model NoteTemplate {
  id                 String            @id @default(uuid())
  orgId              String
  programId          String?
  userId             String?
  scope              NoteTemplateScope
  name               String
  content            String            @db.Text
  availableVariables String[]
  sessionType        String?
  isDefault          Boolean           @default(false)
  createdById        String
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt

  organization Organization  @relation(fields: [orgId], references: [id])
  program      Program?      @relation(fields: [programId], references: [id])
  user         User?         @relation("NoteTemplateOwner", fields: [userId], references: [id])
  createdBy    User          @relation("NoteTemplateCreator", fields: [createdById], references: [id])

  @@index([orgId, scope])
  @@index([programId])
  @@index([sessionType])
}

// ============================================
// FORM CONVERSION (Phase 3 - Photo/PDF to Form)
// ============================================

enum ConversionSourceType {
  PHOTO
  PDF_CLEAN
  PDF_SCANNED
}

enum ConversionStatus {
  PENDING
  PROCESSING
  REVIEW_REQUIRED
  COMPLETED
  FAILED
}

model FormConversion {
  id                     String               @id @default(uuid())
  orgId                  String
  sourceType             ConversionSourceType
  sourcePath             String               // S3 path to original document
  status                 ConversionStatus     @default(PENDING)
  detectedFields         Json?                // Array of detected field definitions
  fieldPositions         Json?                // Field positions for PDF overlay
  confidence             Float?               // Overall confidence score (0-1)
  warnings               String[]             // Array of warning messages
  requiresOriginalExport Boolean              @default(false)
  resultFormId           String?              // Created form ID after completion
  createdById            String
  createdAt              DateTime             @default(now())
  updatedAt              DateTime             @updatedAt
  expiresAt              DateTime?            // For source document retention

  organization Organization @relation(fields: [orgId], references: [id])
  resultForm   Form?        @relation(fields: [resultFormId], references: [id])
  createdBy    User         @relation(fields: [createdById], references: [id])

  @@index([orgId, status])
  @@index([createdById])
}

// ============================================
// AUTOMATED REPORTING (Phase 4)
// ============================================

enum ReportType {
  HUD_APR
  DOL_WORKFORCE
  CALI_GRANTS
  BOARD_REPORT
  IMPACT_REPORT
  CUSTOM
}

enum ReportTemplateStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum ReportStatus {
  GENERATING
  REVIEW_REQUIRED
  COMPLETED
  FAILED
}

enum StorageTier {
  FULL
  COMPRESSED
}

model ReportTemplate {
  id                   String               @id @default(uuid())
  orgId                String
  name                 String
  description          String?
  type                 ReportType
  status               ReportTemplateStatus @default(DRAFT)
  questionnaireAnswers Json                 // Answers to guided questionnaire
  metrics              Json                 // Selected/configured metrics
  sections             Json                 // Report section definitions
  funderRequirements   Json?                // Extracted funder requirements
  aiGeneratedAt        DateTime?
  createdById          String
  publishedById        String?
  publishedAt          DateTime?
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt

  organization Organization @relation(fields: [orgId], references: [id])
  createdBy    User         @relation("ReportTemplateCreator", fields: [createdById], references: [id])
  publishedBy  User?        @relation("ReportTemplatePublisher", fields: [publishedById], references: [id])
  reports      Report[]

  @@index([orgId, status])
  @@index([type])
}

model Report {
  id                   String       @id @default(uuid())
  templateId           String
  orgId                String
  reportingPeriodStart DateTime
  reportingPeriodEnd   DateTime
  status               ReportStatus @default(GENERATING)
  storageTier          StorageTier  @default(FULL)
  pdfPath              String?      // S3 path to generated PDF
  generatedData        Json?        // All calculated metrics data
  narrativeSections    Json?        // AI-generated narrative content
  generatedById        String
  generatedAt          DateTime?
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt

  template     ReportTemplate   @relation(fields: [templateId], references: [id])
  organization Organization     @relation(fields: [orgId], references: [id])
  generatedBy  User             @relation(fields: [generatedById], references: [id])
  snapshots    ReportSnapshot[]

  @@index([orgId, status])
  @@index([templateId])
}

model ReportSnapshot {
  id             String   @id @default(uuid())
  reportId       String
  dataSnapshot   Json     // Complete metric snapshot at generation time
  metricsVersion String   // Version of metrics used
  generatedAt    DateTime @default(now())

  report Report @relation(fields: [reportId], references: [id])

  @@index([reportId])
}

model CustomMetric {
  id           String   @id @default(uuid())
  orgId        String
  baseMetricId String?  // If cloned from pre-built metric
  name         String
  description  String
  calculation  Json     // Metric calculation definition
  version      String
  createdById  String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  organization Organization @relation(fields: [orgId], references: [id])
  createdBy    User         @relation(fields: [createdById], references: [id])

  @@index([orgId])
}

model FunderDocumentLibrary {
  id                    String   @id @default(uuid())
  name                  String
  funderName            String
  documentType          String   // e.g., "APR Instructions", "Data Standards"
  sourcePath            String   // S3 path to original document
  extractedText         String   @db.Text
  extractedRequirements Json     // Structured requirements
  lastUpdated           DateTime
  curatedById           String
  createdAt             DateTime @default(now())

  curatedBy User @relation(fields: [curatedById], references: [id])

  @@index([funderName])
}
