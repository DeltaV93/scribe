// Scrybe Solutions - Database Schema
// Version 2.0 - January 2026

generator client {
  provider        = "prisma-client-js"
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  directUrl  = env("DIRECT_URL")
}

// ============================================
// ENUMS
// ============================================

enum Tier {
  FREE
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

enum FormType {
  INTAKE
  FOLLOWUP
  REFERRAL
  ASSESSMENT
  CUSTOM
}

enum FormStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum FieldType {
  TEXT_SHORT
  TEXT_LONG
  NUMBER
  DATE
  PHONE
  EMAIL
  ADDRESS
  DROPDOWN
  CHECKBOX
  YES_NO
  FILE
  SIGNATURE
}

enum FieldPurpose {
  GRANT_REQUIREMENT
  INTERNAL_OPS
  COMPLIANCE
  OUTCOME_MEASUREMENT
  RISK_ASSESSMENT
  OTHER
}

enum GranteeType {
  TEAM
  USER
}

enum FormRole {
  VIEW
  USE
  EDIT
}

// AuditAction is now a string field for flexibility

enum ScanStatus {
  PENDING
  SCANNING
  CLEAN
  INFECTED
  ERROR
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  PROGRAM_MANAGER
  CASE_MANAGER
  VIEWER
}

// ============================================
// CLIENT & CALL ENUMS (Spec-2)
// ============================================

enum ClientStatus {
  ACTIVE
  ON_HOLD
  CLOSED
  PENDING
}

enum CallStatus {
  INITIATING
  RINGING
  IN_PROGRESS
  COMPLETED
  ABANDONED
  ATTEMPTED
  FAILED
}

enum ProcessingStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  QUEUED_FOR_RETRY
}

enum NoteType {
  INTERNAL
  SHAREABLE
}

enum NoteStatus {
  DRAFT
  PENDING_APPROVAL
  PUBLISHED
  REJECTED
}

enum NotificationType {
  MENTION
  APPROVAL_REQUEST
  APPROVAL_RESULT
  REMINDER
  SYSTEM
}

enum ConsentMode {
  AUTO_RECORDING
  CASE_MANAGER_SCRIPT
  DISABLED
}

enum PhoneNumberRequestStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}

// ============================================
// PROGRAM MANAGEMENT ENUMS
// ============================================

enum ProgramStatus {
  DRAFT
  ACTIVE
  COMPLETED
  CANCELLED
  ARCHIVED
}

enum ProgramLabelType {
  PROGRAM
  COURSE
  CLASS
  WORKSHOP
  TRAINING
  GROUP
}

enum EnrollmentStatus {
  ENROLLED
  IN_PROGRESS
  COMPLETED
  WITHDRAWN
  FAILED
  ON_HOLD
}

enum MaterialType {
  SYLLABUS
  HANDOUT
  PRESENTATION
  WORKSHEET
  ASSESSMENT
  CERTIFICATE_TEMPLATE
  OTHER
}

enum ExtractionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// ============================================
// ATTENDANCE TRACKING ENUMS
// ============================================

enum AttendanceUploadStatus {
  SHEET_GENERATED
  IN_PROGRESS
  PHOTO_UPLOADED
  AI_PROCESSING
  PENDING_REVIEW
  CONFIRMED
  FAILED
  PENDING_OVERRIDE_REVIEW
}

enum AttendanceType {
  PRESENT
  EXCUSED
  ABSENT
}

// ============================================
// GRANT TRACKING ENUMS
// ============================================

enum GrantStatus {
  DRAFT
  ACTIVE
  COMPLETED
  EXPIRED
  ARCHIVED
}

enum MetricType {
  CLIENT_CONTACTS        // Calls made to clients
  CLIENTS_ENROLLED       // Enrollments in programs
  PROGRAM_COMPLETIONS    // Clients completing programs
  CLIENTS_HOUSED         // Housing outcome achieved
  SESSIONS_DELIVERED     // Program sessions held
  FORM_SUBMISSIONS       // Forms completed
  CUSTOM                 // User-defined counting logic
}

enum DeliverableStatus {
  NOT_STARTED
  IN_PROGRESS
  AT_RISK
  COMPLETED
  OVERDUE
}

enum ProgressEventType {
  INCREMENT
  DECREMENT
  ADJUSTMENT
  RESET
}

// ============================================
// WORKFLOW & REMINDER ENUMS
// ============================================

enum TriggerEvent {
  INTAKE_COMPLETED
  ENROLLMENT_CREATED
  CALL_COMPLETED
  SESSION_MISSED
  FORM_SUBMITTED
  CLIENT_CREATED
}

enum ReminderStatus {
  PENDING
  SENT
  ACKNOWLEDGED
  COMPLETED
  OVERDUE
  CANCELLED
}

enum ReminderType {
  FOLLOW_UP_CALL
  DOCUMENT_REQUEST
  APPOINTMENT_REMINDER
  PROGRAM_CHECK_IN
  CUSTOM
}

// ============================================
// ACTION ITEM ENUMS
// ============================================

// ActionItemStatus is defined in Meeting Intelligence section
// Reusing existing enum: OPEN, IN_PROGRESS, COMPLETED, CANCELLED

enum ActionItemSource {
  CALL_TRANSCRIPT
  MANUAL
  WORKFLOW
}

// ============================================
// ORGANIZATION & USERS
// ============================================

model Organization {
  id                    String      @id @default(uuid())
  name                  String
  slug                  String      @unique
  tier                  Tier        @default(FREE)
  purchasedFormPacks    Int         @default(0)
  encryptionKeyId       String?
  webhookUrl            String?

  // Settings
  settings              Json        @default("{}")

  // Feature flags for new features
  featureFlags          Json        @default("{}")

  // User limits by tier (FREE=3, STARTER=10, PROFESSIONAL=50, ENTERPRISE=unlimited)
  userLimit             Int         @default(3)

  // VOIP Settings (Spec-2)
  preferredAreaCode     String?
  recordingRetentionDays Int        @default(30)
  consentMode           ConsentMode @default(CASE_MANAGER_SCRIPT)
  consentRecordingUrl   String?

  // Billing
  stripeCustomerId      String?     @unique

  // Security Settings
  requireMfa            Boolean     @default(false)

  // Session Management Settings
  sessionTimeoutMinutes Int         @default(30)  // 15-60 minutes configurable
  maxConcurrentSessions Int         @default(3)   // Max sessions per user

  // Real-Time Chat Settings (PX-713)
  realTimeChatEnabled   Boolean     @default(false)
  businessHoursStart    String?     // "09:00" (24h format)
  businessHoursEnd      String?     // "17:00" (24h format)
  businessHoursTimezone String?     // "America/New_York"
  businessHoursDays     Int[]       @default([1, 2, 3, 4, 5]) // 0=Sun, 1=Mon...6=Sat

  // Chatbot Intake Settings (PX-702)
  chatbotEnabled        Boolean     @default(false)
  chatbotFormId         String?     // Default form for chatbot intake
  chatbotCrisisContact  String?     // Phone/email for crisis alerts
  chatbotAuthRequired   Boolean     @default(false) // Require auth before chatbot

  // In-Person Recording Settings (PX-703)
  inPersonRecordingEnabled Boolean  @default(false)
  maxRecordingDurationMinutes Int   @default(60)    // Max recording duration (default 60 min)

  // Workforce Development Settings (PX-711)
  workforceEnabled      Boolean     @default(false)

  // Insurance Eligibility Settings (PX-712)
  eligibilityCheckEnabled Boolean   @default(false)

  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt

  // Relations
  users                 User[]
  teams                 Team[]
  forms                 Form[]
  formTemplates         FormTemplate[]
  auditLogs             AuditLog[]
  fileUploads           FileUpload[]
  clients               Client[]
  phoneNumberPool       PhoneNumberPool[]
  phoneNumberRequests   PhoneNumberRequest[]
  userInvitations       UserInvitation[]
  programs              Program[]

  // Messaging Relations (Spec-3)
  messages              Message[]
  smsTemplates          SmsTemplate[]

  // Job Infrastructure Relations
  jobProgress           JobProgress[]
  noteTemplates         NoteTemplate[]

  // Notes Feature Relations
  notes                 Note[]
  noteTags              NoteTag[]
  notifications         Notification[]

  // Form Conversion Relations
  formConversions       FormConversion[]

  // Automated Reporting Relations (Phase 4)
  reportTemplates       ReportTemplate[]
  reports               Report[]
  customMetrics         CustomMetric[]

  // Funder Export Relations
  exportTemplates       ExportTemplate[]
  funderExports         FunderExport[]

  // Import Relations
  importTemplates       ImportTemplate[]
  importBatches         ImportBatch[]

  // Meeting Intelligence Relations
  locations             Location[]
  meetings              Meeting[]
  meetingIntegrations   MeetingIntegration[]

  // Knowledge Base Relations
  knowledgeEntries      KnowledgeEntry[]

  // Grant Tracking Relations (PX-697)
  grants                Grant[]
  workflowRules         WorkflowRule[]
  reminders             Reminder[]
  callActionItems       CallActionItem[]

  // OKR Relations
  objectives            Objective[]

  // Email Integration Relations (PX-705)
  emailLogs             EmailLog[]

  // Real-Time Chat Relations (PX-713)
  chatRooms             ChatRoom[]

  // Quiz Relations (PX-704, PX-707)
  quizzes               Quiz[]

  // Chatbot Intake Relations (PX-702)
  chatSessions          ChatSession[]

  // In-Person Recording Relations (PX-703)
  inPersonRecordings    InPersonRecording[]

  @@index([slug])
  @@index([stripeCustomerId])
}

model User {
  id              String   @id @default(uuid())
  orgId           String
  email           String   @unique
  name            String?
  avatarUrl       String?
  role            UserRole @default(CASE_MANAGER)

  // Supabase Auth
  supabaseUserId  String   @unique

  // Permissions (CRUD split for forms)
  canCreateForms  Boolean  @default(false)
  canReadForms    Boolean  @default(true)
  canUpdateForms  Boolean  @default(false)
  canDeleteForms  Boolean  @default(false)
  canPublishForms Boolean  @default(false)

  // Caseload (Spec-2)
  maxCaseload     Int?

  // Multi-Factor Authentication (MFA)
  mfaEnabled      Boolean  @default(false)
  mfaSecret       String?  // Encrypted TOTP secret
  mfaBackupCodes  String[] @default([]) // Hashed backup codes
  mfaLastUsed     DateTime?
  mfaEnabledAt    DateTime?

  isActive        Boolean  @default(true)
  lastLoginAt     DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  organization    Organization   @relation(fields: [orgId], references: [id], onDelete: Cascade)
  teamMemberships TeamMember[]
  createdForms    Form[]         @relation("FormCreator")
  formVersions    FormVersion[]
  formAccess      FormAccess[]   @relation("AccessGranter")

  // Client & Call Relations (Spec-2)
  assignedClients Client[]       @relation("AssignedClients")
  createdClients  Client[]       @relation("CreatedClients")
  calls           Call[]
  authoredNotes   Note[]         @relation("NoteAuthor")
  approvedNotes   Note[]         @relation("NoteApprover")
  twilioNumber    TwilioNumber?
  formSubmissions FormSubmission[]
  formEditLogs    FormEditLog[]

  // Note Version and Mention Relations
  noteVersions    NoteVersion[]  @relation("NoteVersionEditor")
  noteMentions    NoteMention[]  @relation("NoteMentionedUser")

  // Phone Number Request Relations
  phoneRequests         PhoneNumberRequest[] @relation("PhoneRequests")
  resolvedPhoneRequests PhoneNumberRequest[] @relation("ResolvedRequests")

  // User Invitation Relations
  invitationsSent       UserInvitation[]     @relation("InvitedBy")

  // Deactivation tracking
  deactivatedAt         DateTime?
  deactivatedById       String?

  // Program Relations
  facilitatedPrograms   Program[]            @relation("ProgramFacilitator")
  createdPrograms       Program[]            @relation("ProgramCreator")
  enrolledClients       ProgramEnrollment[]  @relation("EnrolledBy")
  recordedAttendance    SessionAttendance[]  @relation("AttendanceRecordedBy")
  uploadedMaterials     ProgramMaterial[]    @relation("MaterialUploadedBy")

  // Attendance Upload Relations
  attendanceUploads         AttendanceUpload[]          @relation("AttendanceUploadedBy")
  attendanceReviews         AttendanceUpload[]          @relation("AttendanceReviewedBy")
  attendanceOverrides       AttendanceUpload[]          @relation("AttendanceOverrideApprovedBy")
  attendanceVerifications   AttendanceExtractedRecord[] @relation("AttendanceManuallyVerifiedBy")

  // Messaging Relations (Spec-3)
  sentMessages          Message[]            @relation("MessageSender")

  // Job Infrastructure Relations
  jobProgress           JobProgress[]
  notifications         Notification[]

  // Note Template Relations
  ownedNoteTemplates    NoteTemplate[]       @relation("NoteTemplateOwner")
  createdNoteTemplates  NoteTemplate[]       @relation("NoteTemplateCreator")

  // Form Conversion Relations
  formConversions       FormConversion[]

  // Automated Reporting Relations (Phase 4)
  createdReportTemplates  ReportTemplate[]       @relation("ReportTemplateCreator")
  publishedReportTemplates ReportTemplate[]      @relation("ReportTemplatePublisher")
  generatedReports        Report[]
  customMetrics           CustomMetric[]
  curatedFunderDocs       FunderDocumentLibrary[]

  // Funder Export Relations
  createdExportTemplates  ExportTemplate[]       @relation("ExportTemplateCreator")
  generatedFunderExports  FunderExport[]         @relation("FunderExportGenerator")

  // Import Relations
  createdImportTemplates  ImportTemplate[]       @relation("ImportTemplateCreator")
  uploadedImportBatches   ImportBatch[]          @relation("ImportBatchUploader")

  // Meeting Intelligence Relations
  createdMeetings         Meeting[]              @relation("MeetingCreator")
  assignedActionItems     MeetingActionItem[]    @relation("ActionItemAssignee")
  completedActionItems    MeetingActionItem[]    @relation("ActionItemCompleter")
  askedQuestions          MeetingQuestion[]      @relation("QuestionAsker")
  answeredQuestions       MeetingQuestion[]      @relation("QuestionAnswerer")

  // Knowledge Base Relations
  createdKnowledge        KnowledgeEntry[]       @relation("KnowledgeCreator")
  updatedKnowledge        KnowledgeEntry[]       @relation("KnowledgeUpdater")

  // Location Access Control Relations
  locationAccess          UserLocation[]
  grantedLocationAccess   UserLocation[]         @relation("LocationAccessGranter")

  // Password Security (HIPAA Compliance)
  passwordChangedAt     DateTime?
  failedLoginAttempts   Int         @default(0)
  lockedUntil           DateTime?
  mustChangePassword    Boolean     @default(false)

  // Password History Relation
  passwordHistory       PasswordHistory[]

  // User Session Relations
  sessions              UserSession[]

  // Grant Tracking Relations (PX-697)
  createdGrants               Grant[]               @relation("GrantCreator")
  generatedGrantReports       GrantReport[]         @relation("GrantReportGenerator")
  recordedDeliverableProgress DeliverableProgress[] @relation("DeliverableProgressRecorder")
  createdWorkflowRules        WorkflowRule[]        @relation("WorkflowRuleCreator")
  assignedReminders           Reminder[]            @relation("ReminderAssignee")
  completedReminders          Reminder[]            @relation("ReminderCompleter")
  assignedCallActionItems     CallActionItem[]      @relation("CallActionItemAssignee")
  completedCallActionItems    CallActionItem[]      @relation("CallActionItemCompleter")

  // Client Sharing Relations
  clientsSharedWithMe         ClientShare[]         @relation("ClientSharedWith")
  clientsSharedByMe           ClientShare[]         @relation("ClientSharedBy")

  // OKR Relations
  ownedObjectives             Objective[]           @relation("ObjectiveOwner")
  objectiveUpdates            ObjectiveUpdate[]     @relation("ObjectiveUpdateCreator")
  keyResultProgress           KeyResultProgress[]   @relation("KeyResultProgressRecorder")

  // Quiz Relations (PX-704, PX-707)
  createdQuizzes              Quiz[]                @relation("QuizCreator")
  quizAttempts                QuizAttempt[]         @relation("QuizAttemptUser")
  quizAnswerReviews           QuizAnswer[]          @relation("QuizAnswerReviewer")

  // Chatbot Intake Relations (PX-702)
  chatSessionHandoffs         ChatSession[]         @relation("ChatSessionHandoff")

  // In-Person Recording Relations (PX-703)
  inPersonRecordings          InPersonRecording[]

  @@index([orgId])
  @@index([email])
  @@index([supabaseUserId])

  // Case Manager Profile relation
  caseManagerProfile    CaseManagerProfile?
}

// ============================================
// CASE MANAGER PROFILE (Client Matching)
// ============================================

enum AvailabilityStatus {
  AVAILABLE
  LIMITED
  UNAVAILABLE
  ON_LEAVE
}

model CaseManagerProfile {
  id                  String             @id @default(uuid())
  userId              String             @unique
  maxCaseload         Int                @default(30)
  currentCaseload     Int                @default(0)
  skills              String[]           @default([])
  languages           String[]           @default(["English"])
  specializations     String[]           @default([])
  availabilityStatus  AvailabilityStatus @default(AVAILABLE)
  availabilityNote    String?            // e.g., "Back from leave on 2/15"
  preferredClientTypes String[]          @default([]) // e.g., ["families", "veterans", "youth"]
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt

  // Relations
  user                User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([availabilityStatus])
}

// ============================================
// CLIENT MATCH PREFERENCE
// ============================================

model ClientMatchPreference {
  id                  String   @id @default(uuid())
  clientId            String   @unique
  preferredLanguages  String[] @default([])
  requiredSkills      String[] @default([])
  specialNeeds        String[] @default([])
  notes               String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relations
  client              Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
}

// ============================================
// PASSWORD HISTORY (HIPAA Compliance)
// ============================================

model PasswordHistory {
  id            String   @id @default(uuid())
  userId        String
  passwordHash  String
  createdAt     DateTime @default(now())

  // Relations
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}

model Team {
  id          String   @id @default(uuid())
  orgId       String
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  organization Organization  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  members      TeamMember[]
  formAccess   FormAccess[]

  @@unique([orgId, name])
  @@index([orgId])
}

model TeamMember {
  id        String   @id @default(uuid())
  teamId    String
  userId    String
  createdAt DateTime @default(now())

  // Relations
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
}

// ============================================
// FORMS & FIELDS
// ============================================

model Form {
  id          String     @id @default(uuid())
  orgId       String
  name        String
  description String?
  type        FormType
  status      FormStatus @default(DRAFT)
  version     Int        @default(1)

  // Settings (JSON for flexibility)
  settings    Json       @default("{\"allowPartialSaves\": true, \"requireSupervisorReview\": false, \"autoArchiveDays\": null, \"activityTriggers\": []}")

  // Form conversion fingerprint for duplicate detection
  fieldFingerprint String?

  createdById String
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  archivedAt  DateTime?
  publishedAt DateTime?

  // Relations
  organization Organization    @relation(fields: [orgId], references: [id], onDelete: Cascade)
  createdBy    User            @relation("FormCreator", fields: [createdById], references: [id])
  fields       FormField[]
  versions     FormVersion[]
  access       FormAccess[]
  submissions  FormSubmission[]
  conversions  FormConversion[]
  chatSessions ChatSession[]    // Chatbot intake sessions using this form

  @@index([orgId, status])
  @@index([createdById])
  @@index([status])
  @@index([orgId, fieldFingerprint])
}

model FormField {
  id               String       @id @default(uuid())
  formId           String
  slug             String
  name             String
  type             FieldType
  purpose          FieldPurpose
  purposeNote      String?
  helpText         String?

  isRequired       Boolean      @default(false)
  isSensitive      Boolean      @default(false)
  isAiExtractable  Boolean      @default(true)

  // For dropdown/checkbox - array of options
  options          Json?

  // Grouping
  section          String?
  order            Int          @default(0)

  // Conditional logic (React Flow compatible)
  conditionalLogic Json?

  // i18n translations
  translations     Json?

  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  // Relations
  form               Form                @relation(fields: [formId], references: [id], onDelete: Cascade)
  extractionExamples ExtractionExample[]

  @@unique([formId, slug])
  @@index([formId, order])
}

model FormVersion {
  id                  String   @id @default(uuid())
  formId              String
  version             Int
  snapshot            Json
  aiExtractionPrompt  String   @db.Text
  publishedById       String
  publishedAt         DateTime @default(now())

  // Relations
  form        Form             @relation(fields: [formId], references: [id], onDelete: Cascade)
  publishedBy User             @relation(fields: [publishedById], references: [id])
  submissions FormSubmission[]

  @@unique([formId, version])
  @@index([formId])
}

model FormAccess {
  id          String      @id @default(uuid())
  formId      String
  granteeType GranteeType
  granteeId   String
  role        FormRole
  grantedById String
  grantedAt   DateTime    @default(now())

  // Relations
  form      Form  @relation(fields: [formId], references: [id], onDelete: Cascade)
  grantedBy User  @relation("AccessGranter", fields: [grantedById], references: [id])
  team      Team? @relation(fields: [granteeId], references: [id], map: "FormAccess_team_fkey")

  @@unique([formId, granteeType, granteeId])
  @@index([formId])
  @@index([granteeId])
}

// ============================================
// AI EXTRACTION
// ============================================

model ExtractionExample {
  id                String                         @id @default(uuid())
  fieldId           String
  transcriptSnippet String                         @db.Text
  extractedValue    String
  // embedding      Unsupported("vector(1536)")?   // TODO: Re-enable when pgvector is installed
  createdById       String
  createdAt         DateTime                       @default(now())

  // Relations
  field FormField @relation(fields: [fieldId], references: [id], onDelete: Cascade)

  @@index([fieldId])
}

// ============================================
// TEMPLATES
// ============================================

model FormTemplate {
  id               String   @id @default(uuid())
  orgId            String?
  name             String
  description      String?
  tags             String[]
  thumbnail        String?
  useCaseExamples  String[]
  formSnapshot     Json
  isSystemTemplate Boolean  @default(false)
  createdById      String
  createdAt        DateTime @default(now())
  usageCount       Int      @default(0)

  // Relations
  organization Organization? @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([isSystemTemplate])
  @@index([orgId])
}

// ============================================
// SUBMISSIONS
// ============================================

model FormSubmission {
  id              String    @id @default(uuid())
  orgId           String
  formId          String
  formVersionId   String
  clientId        String?
  callId          String?

  // Submission data (encrypted sensitive fields)
  data            Json

  // Status tracking
  status          String    @default("DRAFT") // DRAFT, SUBMITTED, APPROVED, REJECTED
  isComplete      Boolean   @default(false)
  isDraft         Boolean   @default(true)

  // AI extraction metadata
  aiExtractedData Json?
  aiConfidence    Json?
  flaggedFields   String[]  @default([])

  submittedById   String?
  submittedAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  form        Form        @relation(fields: [formId], references: [id], onDelete: Cascade)
  formVersion FormVersion @relation(fields: [formVersionId], references: [id])
  signatures  Signature[]
  client      Client?     @relation(fields: [clientId], references: [id])
  call        Call?       @relation(fields: [callId], references: [id])
  submitter   User?       @relation(fields: [submittedById], references: [id])
  editLogs    FormEditLog[]

  @@index([formId])
  @@index([formVersionId])
  @@index([clientId])
  @@index([callId])
}

model Signature {
  id                String   @id @default(uuid())
  submissionId      String
  fieldId           String
  imageData         Bytes
  imageHash         String
  timestamp         DateTime @default(now())
  signerIp          String
  signerUserAgent   String
  signerSessionId   String
  geolocation       Json?
  deviceFingerprint String?
  consentRecorded   Boolean  @default(true)
  consentText       String?
  documentHash      String?

  // Relations
  submission FormSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@index([submissionId])
}

// ============================================
// FILE HANDLING
// ============================================

model FileUpload {
  id            String     @id @default(uuid())
  orgId         String
  originalName  String
  storagePath   String
  mimeType      String
  sizeBytes     Int
  scanStatus    ScanStatus @default(PENDING)
  scanResult    Json?
  scannedAt     DateTime?
  extractedText String?    @db.Text
  uploadedById  String
  uploadedAt    DateTime   @default(now())

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([scanStatus])
}

// ============================================
// AUDIT & COMPLIANCE
// ============================================

model AuditLog {
  id           String   @id @default(uuid())
  orgId        String
  userId       String?
  action       String   // CREATE, UPDATE, DELETE, VIEW, EXPORT, PUBLISH, etc.
  resource     String   // FORM, SUBMISSION, CLIENT, USER, FILE, etc.
  resourceId   String
  resourceName String?
  details      Json     @default("{}")
  ipAddress    String?
  userAgent    String?

  // Hash chain for immutability
  previousHash String
  hash         String

  timestamp    DateTime @default(now())

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId, timestamp])
  @@index([resource, resourceId])
  @@index([userId])
  @@index([action])
}

model ComplianceReport {
  id            String   @id @default(uuid())
  orgId         String
  reportType    String   // ACTIVITY_SUMMARY, DATA_ACCESS, USER_ACTIVITY, etc.
  startDate     DateTime
  endDate       DateTime
  generatedAt   DateTime @default(now())
  generatedById String
  data          Json
  hash          String   // For integrity verification

  @@index([orgId, reportType])
  @@index([orgId, generatedAt])
}

// ============================================
// BILLING & SUBSCRIPTIONS
// ============================================

model Subscription {
  id                   String   @id @default(uuid())
  orgId                String
  stripeSubscriptionId String   @unique
  stripeCustomerId     String
  tier                 String   // FREE, STARTER, PROFESSIONAL, ENTERPRISE
  status               String   // active, past_due, canceled, etc.
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  cancelAtPeriodEnd    Boolean  @default(false)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@index([orgId])
  @@index([stripeCustomerId])
  @@index([status])
}

model PaymentHistory {
  id               String   @id @default(uuid())
  orgId            String
  stripePaymentId  String   @unique
  amount           Int      // Amount in cents
  currency         String   @default("usd")
  status           String   // succeeded, pending, failed
  description      String?
  type             String   // subscription, form_pack, etc.
  metadata         Json?
  createdAt        DateTime @default(now())

  @@index([orgId])
  @@index([createdAt])
}

// ============================================
// CLIENT MANAGEMENT (Spec-2)
// ============================================

model Client {
  id               String       @id @default(uuid())
  orgId            String
  firstName        String
  lastName         String
  phone            String       // Primary phone (10 digits)
  additionalPhones Json?        // Array of { number, label }
  email            String?
  address          Json?        // { street, city, state, zip, formatted, coordinates }
  internalId       String?      // Org-specific ID for external system sync
  status           ClientStatus @default(ACTIVE)
  assignedTo       String       // Case manager user ID
  createdBy        String

  // Email Bounce Tracking (PX-705)
  emailBounced     Boolean      @default(false)
  emailBouncedAt   DateTime?

  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  deletedAt        DateTime?    // Soft delete

  // Relations
  organization        Organization        @relation(fields: [orgId], references: [id], onDelete: Cascade)
  assignedUser        User                @relation("AssignedClients", fields: [assignedTo], references: [id])
  creator             User                @relation("CreatedClients", fields: [createdBy], references: [id])
  calls               Call[]
  notes               Note[]
  formSubmissions     FormSubmission[]
  programEnrollments  ProgramEnrollment[]

  // Messaging Relations (Spec-3)
  messages            Message[]
  smsPreference       SmsPreference?
  portalTokens        PortalToken[]

  // Portal Session Relations
  portalSessions      PortalSession[]
  clientPIN           ClientPIN?
  phoneVerifications  PhoneVerification[]

  // Import Relations
  importRecordsCreated  ImportRecord[]     @relation("ImportCreatedClient")
  importRecordsUpdated  ImportRecord[]     @relation("ImportUpdatedClient")

  // Reminder Relations (PX-688)
  reminders             Reminder[]

  // Client Matching Relations
  matchPreference       ClientMatchPreference?

  // Client Sharing Relations
  shares                ClientShare[]        @relation("ClientShares")

  // Real-Time Chat Relations (PX-713)
  chatRoom              ChatRoom?

  // Chatbot Intake Relations (PX-702)
  chatbotCreatedSessions ChatSession[] @relation("ChatSessionCreatedClient")

  // Workforce Development Relations (PX-711)
  jobPlacements         JobPlacement[]
  credentials           Credential[]

  // Insurance Eligibility Relations (PX-712)
  insurancePlans        ClientInsurance[]
  eligibilityChecks     EligibilityCheck[]

  // In-Person Recording Relations (PX-703)
  inPersonRecordings    InPersonRecording[]

  @@index([orgId, status])
  @@index([orgId, phone])
  @@index([assignedTo])
}

// ============================================
// CLIENT SHARING
// ============================================

enum ClientSharePermission {
  VIEW    // Can view client data
  EDIT    // Can view and edit client data
  FULL    // Full access including notes, calls, submissions
}

model ClientShare {
  id              String                @id @default(uuid())
  clientId        String
  sharedWithUserId String
  sharedByUserId  String
  orgId           String
  permission      ClientSharePermission @default(VIEW)
  expiresAt       DateTime?             // Optional expiration
  notes           String?               // Reason for sharing
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  revokedAt       DateTime?             // Soft revoke

  // Relations
  client          Client    @relation("ClientShares", fields: [clientId], references: [id], onDelete: Cascade)
  sharedWithUser  User      @relation("ClientSharedWith", fields: [sharedWithUserId], references: [id])
  sharedByUser    User      @relation("ClientSharedBy", fields: [sharedByUserId], references: [id])

  @@unique([clientId, sharedWithUserId])  // Only one active share per user per client
  @@index([clientId])
  @@index([sharedWithUserId])
  @@index([orgId])
  @@index([expiresAt])
}

// ============================================
// CALL MANAGEMENT (Spec-2)
// ============================================

model Call {
  id                  String           @id @default(uuid())
  clientId            String
  caseManagerId       String
  formIds             String[]         // Forms selected for this call
  status              CallStatus       @default(INITIATING)
  startedAt           DateTime
  endedAt             DateTime?
  durationSeconds     Int?

  // Recording
  twilioCallSid       String?          @unique
  recordingUrl        String?          // S3 URL
  recordingRetention  DateTime?        // When to delete based on org policy

  // Transcript
  transcriptRaw       String?          @db.Text
  transcriptJson      Json?            // Array of TranscriptSegment

  // AI Processing
  aiSummary           Json?            // CallSummary structure
  extractedFields     Json?            // Field slug -> value
  confidenceScores    Json?            // Field slug -> ExtractionConfidence
  manualCorrections   Json?            // Array of FieldCorrection

  // Queue for retry
  aiProcessingStatus  ProcessingStatus @default(PENDING)
  aiProcessingError   String?
  aiProcessingRetries Int              @default(0)

  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt

  // Relations
  client              Client           @relation(fields: [clientId], references: [id])
  caseManager         User             @relation(fields: [caseManagerId], references: [id])
  notes               Note[]
  formSubmissions     FormSubmission[]

  // Action Items Relations (PX-689)
  actionItems         CallActionItem[]

  @@index([clientId])
  @@index([caseManagerId])
  @@index([status])
  @@index([aiProcessingStatus])
}

// ============================================
// NOTES (Spec-2)
// ============================================

model Note {
  id         String     @id @default(uuid())
  orgId      String
  clientId   String
  callId     String?    // Optional link to call
  sessionId  String?    // Optional link to program session (for mass notes)
  authorId   String
  type       NoteType   @default(INTERNAL)
  status     NoteStatus @default(DRAFT)
  content    String     @db.Text // Rich text HTML, max 10000 chars
  tags       String[]   // Flexible tagging
  isMassNote Boolean    @default(false) // Flag for mass-created notes
  isDraft    Boolean    @default(false)

  // Approval workflow fields
  approvedById    String?
  approvedAt      DateTime?
  rejectionReason String?

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deletedAt  DateTime? // Soft delete

  // Relations
  organization Organization    @relation(fields: [orgId], references: [id])
  client       Client          @relation(fields: [clientId], references: [id])
  call         Call?           @relation(fields: [callId], references: [id])
  session      ProgramSession? @relation(fields: [sessionId], references: [id])
  author       User            @relation("NoteAuthor", fields: [authorId], references: [id])
  approvedBy   User?           @relation("NoteApprover", fields: [approvedById], references: [id])

  // Version history and mentions
  versions  NoteVersion[]
  mentions  NoteMention[]

  @@index([clientId])
  @@index([callId])
  @@index([sessionId])
  @@index([authorId])
  @@index([orgId, status])
  @@index([orgId, createdAt])
}

// ============================================
// NOTE VERSION HISTORY (HIPAA Compliance)
// ============================================

model NoteVersion {
  id         String   @id @default(uuid())
  noteId     String
  editedById String
  content    String   @db.Text
  createdAt  DateTime @default(now())

  // Relations
  note     Note @relation(fields: [noteId], references: [id], onDelete: Cascade)
  editedBy User @relation("NoteVersionEditor", fields: [editedById], references: [id])

  @@index([noteId])
  @@index([editedById])
}

// ============================================
// NOTE MENTIONS (@mentions)
// ============================================

model NoteMention {
  id              String   @id @default(uuid())
  noteId          String
  mentionedUserId String
  notified        Boolean  @default(false)
  createdAt       DateTime @default(now())

  // Relations
  note          Note @relation(fields: [noteId], references: [id], onDelete: Cascade)
  mentionedUser User @relation("NoteMentionedUser", fields: [mentionedUserId], references: [id])

  @@unique([noteId, mentionedUserId])
  @@index([mentionedUserId])
}

// ============================================
// NOTE TAGS (Predefined Tags)
// ============================================

model NoteTag {
  id           String   @id @default(uuid())
  orgId        String
  programId    String?
  name         String
  colorHash    String   // Auto-generated from name
  isRestricted Boolean  @default(false) // Cannot use on shareable notes
  sortOrder    Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  program      Program?     @relation(fields: [programId], references: [id])

  @@unique([orgId, programId, name])
  @@index([orgId])
  @@index([programId])
}

// ============================================
// TWILIO PHONE NUMBERS (Spec-2)
// ============================================

model TwilioNumber {
  id            String   @id @default(uuid())
  userId        String   @unique
  phoneNumber   String   @unique // E.164 format
  twilioSid     String   @unique
  areaCode      String   // For org preference tracking
  provisionedAt DateTime @default(now())

  // Relations
  user          User     @relation(fields: [userId], references: [id])
}

// ============================================
// PHONE NUMBER POOL (Admin-managed numbers)
// ============================================

model PhoneNumberPool {
  id            String   @id @default(uuid())
  orgId         String
  phoneNumber   String   @unique // E.164 format
  twilioSid     String   @unique
  areaCode      String
  purchasedAt   DateTime @default(now())
  monthlyCost   Decimal  @default(5.00) @db.Decimal(10, 2)

  // Relations
  organization  Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
}

// ============================================
// PHONE NUMBER REQUESTS (Case manager requests)
// ============================================

model PhoneNumberRequest {
  id              String                   @id @default(uuid())
  userId          String
  orgId           String
  status          PhoneNumberRequestStatus @default(PENDING)
  requestedAt     DateTime                 @default(now())
  resolvedAt      DateTime?
  resolvedBy      String?
  rejectionReason String?

  // Relations
  user            User         @relation("PhoneRequests", fields: [userId], references: [id])
  organization    Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  resolver        User?        @relation("ResolvedRequests", fields: [resolvedBy], references: [id])

  @@index([orgId, status])
  @@index([userId])
}

// ============================================
// FORM EDIT LOGS (Spec-2)
// ============================================

model FormEditLog {
  id            String   @id @default(uuid())
  submissionId  String
  fieldId       String
  previousValue Json?
  newValue      Json?
  editedBy      String
  editedAt      DateTime @default(now())
  editReason    String?

  // Relations
  submission    FormSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  editor        User           @relation(fields: [editedBy], references: [id])

  @@index([submissionId])
  @@index([editedBy])
}

// ============================================
// RESOURCE LOCKING (Spec-2)
// ============================================

model ResourceLock {
  id           String   @id @default(uuid())
  resourceType String   // 'form_submission', 'client', etc.
  resourceId   String
  lockedBy     String   // User ID
  lockedAt     DateTime @default(now())
  expiresAt    DateTime // Auto-expire after 5 minutes of inactivity

  @@unique([resourceType, resourceId])
  @@index([expiresAt])
}

// ============================================
// USER INVITATIONS
// ============================================

model UserInvitation {
  id              String           @id @default(uuid())
  email           String
  name            String
  role            UserRole
  teamId          String?
  maxCaseload     Int?

  // Invitation token and status
  token           String           @unique
  status          InvitationStatus @default(PENDING)
  expiresAt       DateTime

  // Tracking timestamps
  acceptedAt      DateTime?
  revokedAt       DateTime?
  reminderSentAt  DateTime?

  // Who sent the invitation
  invitedById     String
  invitedBy       User             @relation("InvitedBy", fields: [invitedById], references: [id])

  // Organization
  orgId           String
  organization    Organization     @relation(fields: [orgId], references: [id], onDelete: Cascade)

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@index([orgId])
  @@index([token])
  @@index([email, orgId])
  @@index([status])
}

// ============================================
// PROGRAM MANAGEMENT
// ============================================

model Program {
  id              String           @id @default(uuid())
  orgId           String
  name            String
  labelType       ProgramLabelType @default(PROGRAM)
  description     String?          @db.Text
  requiredHours   Int?             // Total hours needed for completion
  startDate       DateTime?
  endDate         DateTime?
  schedule        Json?            // Flexible schedule info (e.g., days of week, time, frequency)
  location        String?
  maxEnrollment   Int?             // Maximum number of participants
  facilitatorId   String?
  status          ProgramStatus    @default(DRAFT)
  createdById     String
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  archivedAt      DateTime?

  // Relations
  organization          Organization           @relation(fields: [orgId], references: [id], onDelete: Cascade)
  facilitator           User?                  @relation("ProgramFacilitator", fields: [facilitatorId], references: [id])
  createdBy             User                   @relation("ProgramCreator", fields: [createdById], references: [id])
  sessions              ProgramSession[]
  enrollments           ProgramEnrollment[]
  materials             ProgramMaterial[]
  attendanceSheetConfig AttendanceSheetConfig?
  noteTemplates         NoteTemplate[]

  // Note Tags scoped to this program
  noteTags              NoteTag[]

  // Grant Tracking Relations (PX-697)
  grantLinks            GrantProgramLink[]

  @@index([orgId, status])
  @@index([facilitatorId])
  @@index([createdById])
}

model ProgramSession {
  id              String   @id @default(uuid())
  programId       String
  sessionNumber   Int      // Order/sequence number
  title           String
  topic           String?  @db.Text
  date            DateTime?
  durationMinutes Int?
  notes           String?  @db.Text
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  program           Program             @relation(fields: [programId], references: [id], onDelete: Cascade)
  attendance        SessionAttendance[]
  materials         ProgramMaterial[]
  attendanceUploads AttendanceUpload[]
  massNotes         Note[]              // Mass notes for session

  @@unique([programId, sessionNumber])
  @@index([programId])
  @@index([date])
}

model ProgramEnrollment {
  id              String           @id @default(uuid())
  programId       String
  clientId        String
  enrolledDate    DateTime         @default(now())
  status          EnrollmentStatus @default(ENROLLED)
  hoursOverride   Decimal?         @db.Decimal(6, 2) // Manual override for completed hours
  completionDate  DateTime?
  withdrawalDate  DateTime?
  withdrawalReason String?
  enrolledById    String
  notes           String?          @db.Text
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  // Relations
  program           Program                     @relation(fields: [programId], references: [id], onDelete: Cascade)
  client            Client                      @relation(fields: [clientId], references: [id])
  enrolledBy        User                        @relation("EnrolledBy", fields: [enrolledById], references: [id])
  attendance        SessionAttendance[]
  attendanceCode    AttendanceCode?
  extractedRecords  AttendanceExtractedRecord[]

  @@unique([programId, clientId])
  @@index([programId, status])
  @@index([clientId])
  @@index([enrolledById])
}

model SessionAttendance {
  id              String          @id @default(uuid())
  sessionId       String
  enrollmentId    String
  attended        Boolean         @default(false)
  hoursAttended   Decimal?        @db.Decimal(4, 2) // Actual hours (can differ from session duration)
  notes           String?
  recordedById    String
  recordedAt      DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Extended fields for photo-based attendance tracking
  attendanceType  AttendanceType? // PRESENT, EXCUSED, ABSENT
  uploadSourceId  String?         // Link to AttendanceUpload
  timeIn          DateTime?
  timeOut         DateTime?
  signatureVerified Boolean       @default(false)

  // Relations
  session         ProgramSession    @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  enrollment      ProgramEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  recordedBy      User              @relation("AttendanceRecordedBy", fields: [recordedById], references: [id])

  @@unique([sessionId, enrollmentId])
  @@index([sessionId])
  @@index([enrollmentId])
  @@index([uploadSourceId])
}

model ProgramMaterial {
  id               String           @id @default(uuid())
  programId        String
  sessionId        String?          // Optional - can be program-level or session-specific
  filename         String
  fileUrl          String           // S3 URL
  mimeType         String
  sizeBytes        Int
  materialType     MaterialType     @default(OTHER)
  extractionStatus ExtractionStatus @default(PENDING)
  extractedData    Json?            // AI-extracted syllabus data
  extractionError  String?
  uploadedById     String
  uploadedAt       DateTime         @default(now())

  // Relations
  program          Program         @relation(fields: [programId], references: [id], onDelete: Cascade)
  session          ProgramSession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)
  uploadedBy       User            @relation("MaterialUploadedBy", fields: [uploadedById], references: [id])

  @@index([programId])
  @@index([sessionId])
  @@index([materialType])
  @@index([extractionStatus])
}

// ============================================
// ATTENDANCE TRACKING (Photo-based AI Recognition)
// ============================================

model AttendanceSheetConfig {
  id                     String   @id @default(uuid())
  programId              String   @unique
  includeTimeInOut       Boolean  @default(true)
  includeClientSignature Boolean  @default(true)
  includeNotes           Boolean  @default(true)
  customInstructions     String?  @db.Text
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  // Relations
  program                Program  @relation(fields: [programId], references: [id], onDelete: Cascade)
}

model AttendanceCode {
  id           String   @id @default(uuid())
  enrollmentId String   @unique
  code         String   // Format: BK2847 (consonants + numbers)
  createdAt    DateTime @default(now())

  // Relations
  enrollment   ProgramEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)

  @@index([code])
}

model AttendanceUpload {
  id                    String                  @id @default(uuid())
  sessionId             String
  orgId                 String
  status                AttendanceUploadStatus  @default(SHEET_GENERATED)

  // Sheet generation tracking
  sheetPath             String?                 // S3 path to generated PDF
  sheetGeneratedAt      DateTime?

  // Photo upload tracking
  photoPath             String?                 // S3 path to uploaded photo
  photoUploadedAt       DateTime?
  photoMimeType         String?
  photoSizeBytes        Int?
  enhancedPhotoPath     String?                 // S3 path to enhanced photo

  // AI processing tracking
  aiProcessingStartedAt DateTime?
  aiProcessingEndedAt   DateTime?
  aiRawResponse         Json?
  aiExtractedData       Json?                   // Structured extraction results
  aiConfidence          Float?
  aiError               String?
  aiRetryCount          Int                     @default(0)

  // Review tracking
  reviewedAt            DateTime?
  reviewedById          String?
  reviewNotes           String?                 @db.Text

  // Override handling
  isOverride            Boolean                 @default(false)
  overrideReason        String?                 @db.Text
  overrideApprovedById  String?
  overrideApprovedAt    DateTime?

  // User tracking
  uploadedById          String

  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt

  // Relations
  session               ProgramSession          @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  uploadedBy            User                    @relation("AttendanceUploadedBy", fields: [uploadedById], references: [id])
  reviewedBy            User?                   @relation("AttendanceReviewedBy", fields: [reviewedById], references: [id])
  overrideApprovedBy    User?                   @relation("AttendanceOverrideApprovedBy", fields: [overrideApprovedById], references: [id])
  extractedRecords      AttendanceExtractedRecord[]

  @@index([sessionId])
  @@index([orgId, status])
  @@index([uploadedById])
  @@index([status])
}

model AttendanceExtractedRecord {
  id                   String          @id @default(uuid())
  uploadId             String
  enrollmentId         String?         // Nullable for walk-ins

  // Extracted data
  attendanceType       AttendanceType?
  qrCodeDetected       Boolean         @default(false)
  qrCodeValue          String?
  printedCodeDetected  Boolean         @default(false)
  printedCodeValue     String?
  timeIn               DateTime?
  timeOut              DateTime?
  signatureDetected    Boolean         @default(false)
  notes                String?         @db.Text

  // Confidence and review
  confidence           Float?
  needsReview          Boolean         @default(false)
  reviewFlag           String?         // Reason for flag (e.g., "low_confidence", "no_match", "missing_signature")

  // Manual verification
  isManuallyVerified   Boolean         @default(false)
  manuallyVerifiedById String?
  manuallyVerifiedAt   DateTime?

  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt

  // Relations
  upload               AttendanceUpload   @relation(fields: [uploadId], references: [id], onDelete: Cascade)
  enrollment           ProgramEnrollment? @relation(fields: [enrollmentId], references: [id])
  manuallyVerifiedBy   User?              @relation("AttendanceManuallyVerifiedBy", fields: [manuallyVerifiedById], references: [id])

  @@index([uploadId])
  @@index([enrollmentId])
}

model AttendanceUploadRateLimit {
  id         String   @id @default(uuid())
  userId     String
  sessionId  String
  uploadCount Int     @default(1)
  windowStart DateTime @default(now())

  @@unique([userId, sessionId])
  @@index([windowStart])
}

// ============================================
// SMS/MESSAGING SYSTEM (Spec-3)
// ============================================

enum MessageSenderType {
  CASE_MANAGER
  CLIENT
}

enum MessageStatus {
  DRAFT
  SENT
  DELIVERED
  READ
  FAILED
}

enum SmsDeliveryStatus {
  QUEUED
  SENT
  DELIVERED
  UNDELIVERED
  FAILED
}

// ============================================
// EMAIL INTEGRATION ENUMS (PX-705)
// ============================================

enum EmailStatus {
  QUEUED
  SENT
  DELIVERED
  BOUNCED
  FAILED
}

model Message {
  id            String              @id @default(uuid())
  orgId         String
  clientId      String
  senderId      String?             // User ID (case manager) or null for client replies
  senderType    MessageSenderType
  content       String              @db.Text
  contentHash   String?             // SHA-256 for integrity verification
  status        MessageStatus       @default(SENT)
  sentAt        DateTime            @default(now())
  deliveredAt   DateTime?
  readAt        DateTime?
  expiresAt     DateTime?           // For 7-year retention policy
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  deletedAt     DateTime?           // Soft delete

  // Relations
  organization    Organization        @relation(fields: [orgId], references: [id], onDelete: Cascade)
  client          Client              @relation(fields: [clientId], references: [id])
  sender          User?               @relation("MessageSender", fields: [senderId], references: [id])
  attachments     MessageAttachment[]
  smsNotification SmsNotification?

  // Email Integration Relations (PX-705)
  emailLogs           EmailLog[]

  @@index([clientId, sentAt])
  @@index([orgId, clientId])
  @@index([senderId])
  @@index([status])
}

model MessageAttachment {
  id          String   @id @default(uuid())
  messageId   String
  filename    String
  fileUrl     String   // S3 URL (encrypted at rest with AES-256)
  mimeType    String
  fileSize    Int      // bytes
  uploadedAt  DateTime @default(now())

  message     Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
}

model SmsNotification {
  id              String              @id @default(uuid())
  messageId       String              @unique
  phoneNumber     String              // E.164 format
  twilioSid       String?             @unique
  deliveryStatus  SmsDeliveryStatus   @default(QUEUED)
  sentAt          DateTime?
  deliveredAt     DateTime?
  errorCode       String?
  errorMessage    String?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  message         Message             @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([twilioSid])
  @@index([deliveryStatus])
}

model SmsPreference {
  id            String    @id @default(uuid())
  clientId      String    @unique
  optedIn       Boolean   @default(false)
  phoneNumber   String    // E.164 format
  optedInAt     DateTime?
  optedOutAt    DateTime?
  optInMethod   String?   // "portal", "verbal", "written"
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  client        Client    @relation(fields: [clientId], references: [id])

  @@index([clientId])
}

// ============================================
// EMAIL LOGGING (PX-705)
// ============================================

model EmailLog {
  id              String      @id @default(uuid())
  organizationId  String
  messageId       String?     // Link to Message if applicable
  clientId        String?     // Link to Client if applicable
  recipientEmail  String
  subject         String
  templateId      String?     // Template used (e.g., "client_message", "appointment_reminder")
  body            String?     @db.Text // Email body content
  status          EmailStatus @default(QUEUED)
  sesMessageId    String?     @unique // AWS SES Message ID for tracking
  sentAt          DateTime?
  deliveredAt     DateTime?
  bouncedAt       DateTime?
  bounceType      String?     // "permanent" or "transient"
  bounceReason    String?
  retryCount      Int         @default(0)
  nextRetryAt     DateTime?   // For retry scheduling
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // Relations
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  message         Message?     @relation(fields: [messageId], references: [id])

  @@index([organizationId, status])
  @@index([organizationId, createdAt])
  @@index([sesMessageId])
  @@index([clientId])
  @@index([status, nextRetryAt])
}

model PortalToken {
  id          String    @id @default(uuid())
  clientId    String
  token       String    @unique
  messageId   String?   // Optional: link to specific message
  expiresAt   DateTime  // 24-hour expiry
  usedAt      DateTime?
  createdAt   DateTime  @default(now())

  client      Client    @relation(fields: [clientId], references: [id])

  @@index([token])
  @@index([clientId])
  @@index([expiresAt])
}

// Admin-configurable SMS templates (P1)
model SmsTemplate {
  id          String    @id @default(uuid())
  orgId       String
  name        String
  content     String    // Template with placeholders like {{portal_link}}
  isDefault   Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, name])
  @@index([orgId])
}

// ============================================
// CLIENT PORTAL SESSION MANAGEMENT
// ============================================

model PortalSession {
  id            String    @id @default(uuid())
  clientId      String
  sessionToken  String    @unique
  createdAt     DateTime  @default(now())
  expiresAt     DateTime
  ipAddress     String?
  userAgent     String?
  csrfToken     String

  client        Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([sessionToken])
  @@index([clientId])
  @@index([expiresAt])
}

model ClientPIN {
  id             String    @id @default(uuid())
  clientId       String    @unique
  pinHash        String
  failedAttempts Int       @default(0)
  lockedUntil    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  client         Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
}

model PhoneVerification {
  id          String    @id @default(uuid())
  clientId    String
  phoneNumber String
  codeHash    String
  sentAt      DateTime  @default(now())
  expiresAt   DateTime
  verifiedAt  DateTime?
  attempts    Int       @default(0)

  client      Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([expiresAt])
}

// ============================================
// JOB INFRASTRUCTURE (Phase 1)
// ============================================

enum JobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

model JobProgress {
  id        String    @id @default(uuid())
  type      String    // mass-note-batch, form-conversion, report-generation
  userId    String
  orgId     String
  status    JobStatus @default(PENDING)
  progress  Int       @default(0)
  total     Int       @default(0)
  completed Int       @default(0)
  failed    Int       @default(0)
  result    Json?
  error     String?
  metadata  Json?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  user         User         @relation(fields: [userId], references: [id])
  organization Organization @relation(fields: [orgId], references: [id])

  @@index([userId, status])
  @@index([orgId, type])
}

model Notification {
  id        String           @id @default(uuid())
  orgId     String
  userId    String
  type      NotificationType
  title     String
  body      String?          @db.Text
  actionUrl String?
  metadata  Json?
  isRead    Boolean          @default(false)
  readAt    DateTime?
  createdAt DateTime         @default(now())

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id])

  @@index([userId, isRead])
  @@index([orgId, createdAt])
}

// ============================================
// NOTE TEMPLATES (Phase 2 - Mass Notes)
// ============================================

enum NoteTemplateScope {
  ORG
  PROGRAM
  USER
}

model NoteTemplate {
  id                 String            @id @default(uuid())
  orgId              String
  programId          String?
  userId             String?
  scope              NoteTemplateScope
  name               String
  content            String            @db.Text
  availableVariables String[]
  sessionType        String?
  isDefault          Boolean           @default(false)
  createdById        String
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt

  organization Organization  @relation(fields: [orgId], references: [id])
  program      Program?      @relation(fields: [programId], references: [id])
  user         User?         @relation("NoteTemplateOwner", fields: [userId], references: [id])
  createdBy    User          @relation("NoteTemplateCreator", fields: [createdById], references: [id])

  @@index([orgId, scope])
  @@index([programId])
  @@index([sessionType])
}

// ============================================
// FORM CONVERSION (Phase 3 - Photo/PDF to Form)
// ============================================

enum ConversionSourceType {
  PHOTO
  PDF_CLEAN
  PDF_SCANNED
}

enum ConversionStatus {
  PENDING
  PROCESSING
  REVIEW_REQUIRED
  COMPLETED
  FAILED
}

model FormConversion {
  id                     String               @id @default(uuid())
  orgId                  String
  sourceType             ConversionSourceType
  sourcePath             String               // S3 path to original document
  status                 ConversionStatus     @default(PENDING)
  detectedFields         Json?                // Array of detected field definitions
  fieldPositions         Json?                // Field positions for PDF overlay
  confidence             Float?               // Overall confidence score (0-1)
  warnings               String[]             // Array of warning messages
  requiresOriginalExport Boolean              @default(false)
  resultFormId           String?              // Created form ID after completion
  createdById            String
  createdAt              DateTime             @default(now())
  updatedAt              DateTime             @updatedAt
  expiresAt              DateTime?            // For source document retention

  organization Organization @relation(fields: [orgId], references: [id])
  resultForm   Form?        @relation(fields: [resultFormId], references: [id])
  createdBy    User         @relation(fields: [createdById], references: [id])

  @@index([orgId, status])
  @@index([createdById])
}

// ============================================
// AUTOMATED REPORTING (Phase 4)
// ============================================

enum ReportType {
  HUD_APR
  DOL_WORKFORCE
  CALI_GRANTS
  BOARD_REPORT
  IMPACT_REPORT
  CUSTOM
}

enum ReportTemplateStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum ReportStatus {
  GENERATING
  REVIEW_REQUIRED
  COMPLETED
  FAILED
}

enum StorageTier {
  FULL
  COMPRESSED
}

model ReportTemplate {
  id                   String               @id @default(uuid())
  orgId                String
  name                 String
  description          String?
  type                 ReportType
  status               ReportTemplateStatus @default(DRAFT)
  questionnaireAnswers Json                 // Answers to guided questionnaire
  metrics              Json                 // Selected/configured metrics
  sections             Json                 // Report section definitions
  funderRequirements   Json?                // Extracted funder requirements
  aiGeneratedAt        DateTime?
  createdById          String
  publishedById        String?
  publishedAt          DateTime?
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt

  organization Organization @relation(fields: [orgId], references: [id])
  createdBy    User         @relation("ReportTemplateCreator", fields: [createdById], references: [id])
  publishedBy  User?        @relation("ReportTemplatePublisher", fields: [publishedById], references: [id])
  reports      Report[]

  @@index([orgId, status])
  @@index([type])
}

model Report {
  id                   String       @id @default(uuid())
  templateId           String
  orgId                String
  reportingPeriodStart DateTime
  reportingPeriodEnd   DateTime
  status               ReportStatus @default(GENERATING)
  storageTier          StorageTier  @default(FULL)
  pdfPath              String?      // S3 path to generated PDF
  generatedData        Json?        // All calculated metrics data
  narrativeSections    Json?        // AI-generated narrative content
  generatedById        String
  generatedAt          DateTime?
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt

  template     ReportTemplate   @relation(fields: [templateId], references: [id])
  organization Organization     @relation(fields: [orgId], references: [id])
  generatedBy  User             @relation(fields: [generatedById], references: [id])
  snapshots    ReportSnapshot[]

  @@index([orgId, status])
  @@index([templateId])
}

model ReportSnapshot {
  id             String   @id @default(uuid())
  reportId       String
  dataSnapshot   Json     // Complete metric snapshot at generation time
  metricsVersion String   // Version of metrics used
  generatedAt    DateTime @default(now())

  report Report @relation(fields: [reportId], references: [id])

  @@index([reportId])
}

model CustomMetric {
  id           String   @id @default(uuid())
  orgId        String
  baseMetricId String?  // If cloned from pre-built metric
  name         String
  description  String
  calculation  Json     // Metric calculation definition
  version      String
  createdById  String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  organization Organization @relation(fields: [orgId], references: [id])
  createdBy    User         @relation(fields: [createdById], references: [id])

  @@index([orgId])
}

model FunderDocumentLibrary {
  id                    String   @id @default(uuid())
  name                  String
  funderName            String
  documentType          String   // e.g., "APR Instructions", "Data Standards"
  sourcePath            String   // S3 path to original document
  extractedText         String   @db.Text
  extractedRequirements Json     // Structured requirements
  lastUpdated           DateTime
  curatedById           String
  createdAt             DateTime @default(now())

  curatedBy User @relation(fields: [curatedById], references: [id])

  @@index([funderName])
}

// ============================================
// FUNDER DATA EXPORTS (Spec - Data Integration)
// ============================================

enum ExportType {
  CAP60
  DOL_WIPS
  CALI_GRANTS
  HUD_HMIS
  CUSTOM
}

enum ExportTemplateStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum ExportStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  VALIDATION_REQUIRED
}

model ExportTemplate {
  id                String              @id @default(uuid())
  orgId             String
  name              String
  description       String?
  exportType        ExportType
  status            ExportTemplateStatus @default(DRAFT)
  fieldMappings     Json                // Array of field mapping definitions
  sourceFormIds     String[]            // Forms to extract data from
  validationRules   Json?
  outputFormat      String              @default("CSV")
  outputConfig      Json?               // delimiter, encoding, headers
  scheduleEnabled       Boolean             @default(false)
  scheduleCron          String?
  scheduleTimezone      String              @default("America/Los_Angeles")
  lastScheduledRunAt    DateTime?
  nextScheduledRunAt    DateTime?
  scheduleFailureCount  Int                 @default(0)
  createdById           String
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  organization      Organization        @relation(fields: [orgId], references: [id])
  createdBy         User                @relation("ExportTemplateCreator", fields: [createdById], references: [id])
  exports           FunderExport[]

  // Grant Relations (PX-697)
  grants            Grant[]

  @@index([orgId, status])
  @@index([exportType])
}

model FunderExport {
  id                String              @id @default(uuid())
  orgId             String
  templateId        String
  status            ExportStatus        @default(PENDING)
  periodStart       DateTime
  periodEnd         DateTime
  programIds        String[]
  clientIds         String[]
  filePath          String?
  recordCount       Int?
  validationErrors  Json?
  warnings          Json?
  generatedById     String
  generatedAt       DateTime?
  processingTimeMs  Int?
  createdAt         DateTime            @default(now())

  organization      Organization        @relation(fields: [orgId], references: [id])
  template          ExportTemplate      @relation(fields: [templateId], references: [id])
  generatedBy       User                @relation("FunderExportGenerator", fields: [generatedById], references: [id])

  @@index([orgId, status])
  @@index([templateId])
}

// ============================================
// IMPORT MODELS (Phase 3: Smart Import)
// ============================================

enum ImportStatus {
  PENDING
  PARSING
  MAPPING
  READY
  PROCESSING
  COMPLETED
  FAILED
  ROLLED_BACK
}

enum ImportRecordStatus {
  PENDING
  CREATED
  UPDATED
  SKIPPED
  FAILED
  ROLLED_BACK
}

enum DuplicateAction {
  SKIP
  UPDATE
  CREATE_NEW
  MERGE
}

model ImportTemplate {
  id                  String              @id @default(uuid())
  orgId               String
  name                String
  description         String?
  sourceSystem        String?             // e.g., "CAP60", "Excel", "Apricot"
  fileFormat          String              @default("CSV") // CSV, XLSX, JSON
  fieldMappings       Json                // Array of field mapping definitions
  duplicateSettings   Json?               // Duplicate detection configuration
  defaultAction       DuplicateAction     @default(SKIP)
  isActive            Boolean             @default(true)
  createdById         String
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  organization        Organization        @relation(fields: [orgId], references: [id])
  createdBy           User                @relation("ImportTemplateCreator", fields: [createdById], references: [id])
  batches             ImportBatch[]

  @@index([orgId, isActive])
}

model ImportBatch {
  id                  String              @id @default(uuid())
  orgId               String
  templateId          String?
  status              ImportStatus        @default(PENDING)
  fileName            String
  filePath            String              // S3 path to uploaded file
  fileSize            Int
  totalRows           Int?
  processedRows       Int                 @default(0)
  createdCount        Int                 @default(0)
  updatedCount        Int                 @default(0)
  skippedCount        Int                 @default(0)
  failedCount         Int                 @default(0)
  fieldMappings       Json?               // Mappings used for this batch
  duplicateSettings   Json?               // Duplicate settings used
  previewData         Json?               // First N rows for preview
  detectedColumns     String[]            // Column headers from file
  suggestedMappings   Json?               // AI-suggested mappings
  validationErrors    Json?               // Batch-level validation errors
  rollbackAvailableUntil DateTime?        // 24 hours after completion
  rollbackExecutedAt  DateTime?
  uploadedById        String
  startedAt           DateTime?
  completedAt         DateTime?
  createdAt           DateTime            @default(now())

  organization        Organization        @relation(fields: [orgId], references: [id])
  template            ImportTemplate?     @relation(fields: [templateId], references: [id])
  uploadedBy          User                @relation("ImportBatchUploader", fields: [uploadedById], references: [id])
  records             ImportRecord[]

  @@index([orgId, status])
  @@index([templateId])
}

model ImportRecord {
  id                  String              @id @default(uuid())
  batchId             String
  rowNumber           Int
  status              ImportRecordStatus  @default(PENDING)
  action              DuplicateAction?
  sourceData          Json                // Original row data
  mappedData          Json?               // Data after field mapping
  duplicateMatches    Json?               // Matched existing records
  selectedMatchId     String?             // Which duplicate was selected for update/merge
  createdClientId     String?             // If new client was created
  updatedClientId     String?             // If existing client was updated
  validationErrors    Json?               // Row-level validation errors
  processingNotes     String?
  processedAt         DateTime?

  batch               ImportBatch         @relation(fields: [batchId], references: [id], onDelete: Cascade)
  createdClient       Client?             @relation("ImportCreatedClient", fields: [createdClientId], references: [id])
  updatedClient       Client?             @relation("ImportUpdatedClient", fields: [updatedClientId], references: [id])

  @@index([batchId, status])
  @@index([createdClientId])
  @@index([updatedClientId])
}

// ============================================
// LOCATION HIERARCHY (For Access Control)
// ============================================

enum LocationType {
  STORE
  DISTRICT
  REGION
  HEADQUARTERS
}

enum LocationAccessLevel {
  VIEW    // Can view meetings/data at this location
  EDIT    // Can view and edit meetings/data at this location
  MANAGE  // Full control including assigning access to others
}

model Location {
  id                  String              @id @default(uuid())
  orgId               String
  name                String
  type                LocationType
  code                String?             // Store number, district code, etc.

  // Hierarchy
  parentId            String?             // Parent location (e.g., district -> region)

  // Address
  address             Json?               // { street, city, state, zip }

  // Metadata
  isActive            Boolean             @default(true)
  timezone            String              @default("America/Los_Angeles")

  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  organization        Organization        @relation(fields: [orgId], references: [id])
  parent              Location?           @relation("LocationHierarchy", fields: [parentId], references: [id])
  children            Location[]          @relation("LocationHierarchy")
  meetings            Meeting[]
  userAccess          UserLocation[]

  @@unique([orgId, code])
  @@index([orgId, type])
  @@index([parentId])
}

// User-Location access assignment (join table)
model UserLocation {
  id                  String              @id @default(uuid())
  userId              String
  locationId          String
  accessLevel         LocationAccessLevel @default(VIEW)

  // Who granted access and when
  grantedById         String?
  grantedAt           DateTime            @default(now())

  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  user                User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  location            Location            @relation(fields: [locationId], references: [id], onDelete: Cascade)
  grantedBy           User?               @relation("LocationAccessGranter", fields: [grantedById], references: [id])

  @@unique([userId, locationId])
  @@index([userId])
  @@index([locationId])
}

// ============================================
// MEETING INTELLIGENCE (Knowledge Base Phase 1)
// ============================================

enum MeetingStatus {
  SCHEDULED
  JOINING
  RECORDING
  PROCESSING
  COMPLETED
  FAILED
}

enum MeetingSource {
  TEAMS
  ZOOM
  UPLOAD      // Manual audio/video upload
  GOOGLE_MEET
}

enum ActionItemStatus {
  OPEN
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model Meeting {
  id                  String              @id @default(uuid())
  orgId               String
  title               String
  description         String?
  status              MeetingStatus       @default(SCHEDULED)
  source              MeetingSource       @default(UPLOAD)

  // External meeting info
  externalMeetingId   String?             // Teams/Zoom meeting ID
  externalJoinUrl     String?

  // Scheduling
  scheduledStartAt    DateTime?
  scheduledEndAt      DateTime?
  actualStartAt       DateTime?
  actualEndAt         DateTime?
  durationSeconds     Int?

  // Recording
  recordingPath       String?             // S3 path to recording
  recordingSize       Int?

  // Processing
  processingStartedAt DateTime?
  processingCompletedAt DateTime?
  processingError     String?

  // Participants (stored as JSON for flexibility with external systems)
  participants        Json?               // Array of { email, name, role, speakerId? }
  participantCount    Int?

  // Distribution
  summaryEmailSentAt  DateTime?
  emailRecipients     String[]            // Email addresses that received summary

  // Metadata
  locationId          String?             // For location-based access control
  tags                String[]

  createdById         String
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  organization        Organization        @relation(fields: [orgId], references: [id])
  createdBy           User                @relation("MeetingCreator", fields: [createdById], references: [id])
  location            Location?           @relation(fields: [locationId], references: [id])
  transcript          MeetingTranscript?
  summary             MeetingSummary?
  actionItems         MeetingActionItem[]
  questions           MeetingQuestion[]
  knowledgeEntries    KnowledgeEntry[]

  @@index([orgId, status])
  @@index([orgId, scheduledStartAt])
  @@index([locationId])
}

model MeetingTranscript {
  id                  String              @id @default(uuid())
  meetingId           String              @unique

  // Full transcript
  fullText            String              // Complete transcript text
  wordCount           Int?

  // Speaker-diarized segments
  segments            Json                // Array of { speakerId, speakerName, startTime, endTime, text, confidence }

  // Processing metadata
  language            String              @default("en")
  transcriptionModel  String?             // e.g., "deepgram-nova-2", "whisper-large-v3"
  wordErrorRate       Float?              // Estimated WER if available
  processingTimeMs    Int?

  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  meeting             Meeting             @relation(fields: [meetingId], references: [id], onDelete: Cascade)
}

model MeetingSummary {
  id                  String              @id @default(uuid())
  meetingId           String              @unique

  // Executive summary
  executiveSummary    String              // 2-3 paragraph overview

  // Structured extractions
  keyPoints           Json                // Array of { point, context?, speakerName? }
  decisions           Json                // Array of { decision, context?, participants? }
  topicsDiscussed     String[]            // Topic tags/categories

  // AI metadata
  summaryModel        String?             // e.g., "claude-sonnet-4"
  tokensUsed          Int?
  processingTimeMs    Int?

  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  meeting             Meeting             @relation(fields: [meetingId], references: [id], onDelete: Cascade)
}

model MeetingActionItem {
  id                  String              @id @default(uuid())
  meetingId           String

  description         String
  assigneeName        String?             // Name mentioned in meeting
  assigneeEmail       String?             // Resolved email if found
  assigneeUserId      String?             // Linked user if matched
  dueDate             DateTime?
  status              ActionItemStatus    @default(OPEN)

  // Context from transcript
  contextSnippet      String?             // Transcript excerpt where this was mentioned
  timestampSeconds    Int?                // When in meeting this was discussed

  // Tracking
  completedAt         DateTime?
  completedById       String?

  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  meeting             Meeting             @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  assigneeUser        User?               @relation("ActionItemAssignee", fields: [assigneeUserId], references: [id])
  completedBy         User?               @relation("ActionItemCompleter", fields: [completedById], references: [id])

  @@index([meetingId])
  @@index([assigneeUserId, status])
  @@index([status])
}

model MeetingQuestion {
  id                  String              @id @default(uuid())
  meetingId           String

  question            String
  askedByName         String?             // Speaker who asked
  askedByUserId       String?

  // Answer tracking
  isAnswered          Boolean             @default(false)
  answer              String?
  answeredByName      String?
  answeredByUserId    String?
  answeredAt          DateTime?

  // Context
  contextSnippet      String?
  timestampSeconds    Int?

  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  meeting             Meeting             @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  askedBy             User?               @relation("QuestionAsker", fields: [askedByUserId], references: [id])
  answeredBy          User?               @relation("QuestionAnswerer", fields: [answeredByUserId], references: [id])

  @@index([meetingId])
  @@index([isAnswered])
}

// ============================================
// KNOWLEDGE BASE / INSTITUTIONAL MEMORY
// ============================================

enum KnowledgeSource {
  MEETING         // Extracted from meeting summaries
  DOCUMENT        // From uploaded documents
  MANUAL          // Manually entered by users
}

model KnowledgeEntry {
  id                  String              @id @default(uuid())
  orgId               String
  title               String
  content             String              @db.Text
  summary             String?             // AI-generated summary
  source              KnowledgeSource     @default(MANUAL)

  // Source references
  meetingId           String?             // Link to source meeting
  documentPath        String?             // S3 path if from document

  // Categorization
  tags                String[]
  category            String?             // e.g., "Policy", "Decision", "Process"

  // Vector embedding for semantic search (stored reference)
  embeddingId         String?             // External embedding ID (e.g., from vector DB)
  embeddingVector     Float[]             // Stored embedding vector for local search

  // Metadata
  createdById         String
  lastUpdatedById     String?
  isArchived          Boolean             @default(false)
  archivedAt          DateTime?

  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  // Relations
  organization        Organization        @relation(fields: [orgId], references: [id], onDelete: Cascade)
  meeting             Meeting?            @relation(fields: [meetingId], references: [id], onDelete: SetNull)
  createdBy           User                @relation("KnowledgeCreator", fields: [createdById], references: [id])
  lastUpdatedBy       User?               @relation("KnowledgeUpdater", fields: [lastUpdatedById], references: [id])

  @@index([orgId, source])
  @@index([orgId, category])
  @@index([createdById])
  @@index([meetingId])
  @@index([tags])
}

// ============================================
// MEETING PLATFORM INTEGRATIONS
// ============================================

enum MeetingPlatform {
  TEAMS
  ZOOM
  GOOGLE_MEET
}

enum IntegrationStatus {
  PENDING       // OAuth flow initiated
  ACTIVE        // Successfully connected
  EXPIRED       // Token expired, needs refresh
  ERROR         // Connection error
  DISCONNECTED  // User disconnected
}

model MeetingIntegration {
  id                  String              @id @default(uuid())
  orgId               String
  platform            MeetingPlatform

  // OAuth credentials (encrypted in production)
  accessToken         String?             // Encrypted access token
  refreshToken        String?             // Encrypted refresh token
  tokenExpiresAt      DateTime?

  // Platform-specific identifiers
  externalUserId      String?             // User ID on the platform
  externalTenantId    String?             // For Teams: tenant ID

  // Webhook configuration
  webhookId           String?             // Platform webhook subscription ID
  webhookSecret       String?             // Webhook verification secret
  webhookExpiresAt    DateTime?           // When webhook subscription expires

  // Connection status
  status              IntegrationStatus   @default(PENDING)
  lastSyncAt          DateTime?
  lastError           String?
  errorCount          Int                 @default(0)

  // Settings
  settings            Json                @default("{}")  // Platform-specific settings
  autoRecordEnabled   Boolean             @default(true)  // Auto-capture recordings
  syncCalendarEnabled Boolean             @default(false) // Sync calendar events

  // Audit
  connectedById       String              // User who set up the integration
  connectedAt         DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  // Relations
  organization        Organization        @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, platform])
  @@index([orgId, status])
  @@index([platform])
}

// ============================================
// ENCRYPTION KEY MANAGEMENT (PHI Protection)
// ============================================

model EncryptionKey {
  id              String    @id @default(uuid())
  organizationId  String

  // Encrypted DEK (Data Encryption Key)
  // Encrypted by AWS KMS master key
  encryptedDek    String    @db.Text

  // Key versioning for rotation support
  keyVersion      Int       @default(1)
  isActive        Boolean   @default(true)

  // Timestamps
  createdAt       DateTime  @default(now())
  rotatedAt       DateTime? // When this key was rotated out

  @@index([organizationId, isActive])
  @@index([organizationId, keyVersion])
}

// ============================================
// USER SESSION MANAGEMENT
// ============================================

model UserSession {
  id                  String    @id @default(uuid())
  userId              String
  token               String    @unique  // Secure session token
  deviceInfo          Json               // { browser, os, device, isMobile, userAgent }
  ipAddress           String
  lastActivity        DateTime  @default(now())
  createdAt           DateTime  @default(now())
  expiresAt           DateTime           // Session expiration time
  isActive            Boolean   @default(true)

  // Termination tracking
  terminatedAt        DateTime?
  terminationReason   String?            // TIMEOUT, USER_LOGOUT, PASSWORD_CHANGE, MFA_CHANGE, ADMIN_REVOKED, etc.

  // Relations
  user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isActive])
  @@index([token])
  @@index([expiresAt])
  @@index([userId, lastActivity])
}

// ============================================
// GRANT TRACKING (PX-697)
// ============================================

model Grant {
  id              String       @id @default(uuid())
  orgId           String
  name            String
  funderName      String?      // e.g., "HUD", "DOL", "CalGrants"
  grantNumber     String?      // External grant reference number
  description     String?      @db.Text
  status          GrantStatus  @default(DRAFT)

  // Grant Period
  startDate       DateTime
  endDate         DateTime

  // Reporting Configuration
  reportingFrequency  String?  // "monthly", "quarterly", "annually"
  exportTemplateId    String?  // Link to ExportTemplate for auto-reports

  // Notification Settings (JSON for flexibility)
  notificationSettings Json     @default("{}")
  // Structure: { progressAlerts: [25, 50, 75, 100], daysBeforeDeadline: [30, 7, 1], recipients: [] }

  createdById     String
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  archivedAt      DateTime?

  // Relations
  organization    Organization      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  createdBy       User              @relation("GrantCreator", fields: [createdById], references: [id])
  exportTemplate  ExportTemplate?   @relation(fields: [exportTemplateId], references: [id])
  deliverables    GrantDeliverable[]
  programLinks    GrantProgramLink[]
  reports         GrantReport[]

  @@index([orgId, status])
  @@index([endDate])
}

model GrantDeliverable {
  id              String             @id @default(uuid())
  grantId         String
  name            String             // e.g., "Enroll 50 clients in workforce training"
  description     String?            @db.Text
  metricType      MetricType

  // Target & Progress
  targetValue     Int
  currentValue    Int                @default(0)

  // Custom metric configuration (for CUSTOM type)
  customConfig    Json?              // { formFieldSlug: "employed", countCondition: "equals:true" }

  // Deadline (can differ from grant end date)
  dueDate         DateTime?

  // Status (computed but cached for performance)
  status          DeliverableStatus  @default(NOT_STARTED)
  completedAt     DateTime?

  // Auto-report generation
  autoReportOnComplete Boolean       @default(true)
  reportTemplateId     String?       // Optional: specific template for this deliverable

  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  // Relations
  grant           Grant              @relation(fields: [grantId], references: [id], onDelete: Cascade)
  progressEvents  DeliverableProgress[]

  @@index([grantId])
  @@index([status])
  @@index([metricType])
}

model GrantProgramLink {
  id              String    @id @default(uuid())
  grantId         String
  programId       String
  createdAt       DateTime  @default(now())

  // Relations
  grant           Grant     @relation(fields: [grantId], references: [id], onDelete: Cascade)
  program         Program   @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@unique([grantId, programId])
  @@index([grantId])
  @@index([programId])
}

model DeliverableProgress {
  id              String             @id @default(uuid())
  deliverableId   String
  eventType       ProgressEventType
  delta           Int                // +1 for increment, -1 for decrement, etc.
  previousValue   Int
  newValue        Int

  // Source tracking (what triggered this event)
  sourceType      String             // "enrollment", "session", "call", "form_submission", "manual"
  sourceId        String?            // ID of the source record

  // Context
  notes           String?
  recordedById    String?
  recordedAt      DateTime           @default(now())

  // Relations
  deliverable     GrantDeliverable   @relation(fields: [deliverableId], references: [id], onDelete: Cascade)
  recordedBy      User?              @relation("DeliverableProgressRecorder", fields: [recordedById], references: [id])

  @@index([deliverableId, recordedAt])
  @@index([sourceType, sourceId])
}

model GrantReport {
  id              String    @id @default(uuid())
  grantId         String
  orgId           String

  // Report Period
  periodStart     DateTime
  periodEnd       DateTime

  // Generated Content
  reportType      String    // "progress", "completion", "scheduled"
  dataSnapshot    Json      // Snapshot of all deliverable values at generation time
  narrativeSummary String?  @db.Text  // AI-generated narrative
  pdfPath         String?   // S3 path to PDF

  generatedById   String
  generatedAt     DateTime  @default(now())

  // Relations
  grant           Grant     @relation(fields: [grantId], references: [id], onDelete: Cascade)
  generatedBy     User      @relation("GrantReportGenerator", fields: [generatedById], references: [id])

  @@index([grantId, periodEnd])
  @@index([orgId])
}

// ============================================
// WORKFLOW RULES & REMINDERS (PX-688)
// ============================================

model WorkflowRule {
  id              String       @id @default(uuid())
  orgId           String
  name            String
  description     String?
  triggerEvent    TriggerEvent
  conditions      Json?        // Optional conditions as JSON
  delayDays       Int          // Days after trigger to create reminder
  reminderType    ReminderType
  assignToRole    UserRole?    // Role to assign reminder to
  isActive        Boolean      @default(true)

  createdById     String
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Relations
  organization    Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  createdBy       User         @relation("WorkflowRuleCreator", fields: [createdById], references: [id])
  reminders       Reminder[]

  @@index([orgId, isActive])
  @@index([triggerEvent])
}

model Reminder {
  id              String         @id @default(uuid())
  orgId           String
  workflowRuleId  String?        // Null if manually created
  clientId        String
  assignedToId    String
  title           String
  description     String?
  dueDate         DateTime
  status          ReminderStatus @default(PENDING)
  priority        Int            @default(2) // 1=High, 2=Normal, 3=Low

  sentAt          DateTime?
  acknowledgedAt  DateTime?
  completedAt     DateTime?
  completedById   String?

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Relations
  organization    Organization   @relation(fields: [orgId], references: [id], onDelete: Cascade)
  workflowRule    WorkflowRule?  @relation(fields: [workflowRuleId], references: [id])
  client          Client         @relation(fields: [clientId], references: [id])
  assignedTo      User           @relation("ReminderAssignee", fields: [assignedToId], references: [id])
  completedBy     User?          @relation("ReminderCompleter", fields: [completedById], references: [id])

  @@index([orgId, status])
  @@index([assignedToId, status])
  @@index([clientId])
  @@index([dueDate])
}

// ============================================
// CALL ACTION ITEMS (PX-689)
// ============================================

model CallActionItem {
  id              String           @id @default(uuid())
  callId          String
  orgId           String
  description     String
  assigneeName    String?          // Name mentioned in transcript
  assigneeUserId  String?          // Matched to user if possible
  assigneeRole    String?          // "CASE_MANAGER", "CLIENT", "OTHER"
  dueDate         DateTime?
  status          ActionItemStatus @default(OPEN)
  source          ActionItemSource @default(CALL_TRANSCRIPT)
  priority        String?          // "HIGH", "NORMAL", "LOW"

  // AI extraction metadata
  contextSnippet  String?          // Quote from transcript
  timestampSeconds Int?            // Position in call
  aiConfidence    Float?           // 0-1 confidence score

  completedAt     DateTime?
  completedById   String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  // Relations
  call            Call             @relation(fields: [callId], references: [id], onDelete: Cascade)
  organization    Organization     @relation(fields: [orgId], references: [id], onDelete: Cascade)
  assigneeUser    User?            @relation("CallActionItemAssignee", fields: [assigneeUserId], references: [id])
  completedBy     User?            @relation("CallActionItemCompleter", fields: [completedById], references: [id])

  @@index([callId])
  @@index([orgId, status])
  @@index([assigneeUserId, status])
}

// ============================================
// OKR TRACKING (Objectives & Key Results)
// ============================================

enum ObjectiveStatus {
  DRAFT
  ACTIVE
  COMPLETED
  CANCELLED
}

enum KeyResultStatus {
  NOT_STARTED
  IN_PROGRESS
  AT_RISK
  COMPLETED
}

model Objective {
  id              String           @id @default(uuid())
  orgId           String
  title           String
  description     String?          @db.Text
  ownerId         String           // User who owns this objective
  parentId        String?          // For hierarchical objectives
  status          ObjectiveStatus  @default(DRAFT)

  // Time period
  startDate       DateTime?
  endDate         DateTime?

  // Progress (calculated from key results, cached for performance)
  progress        Int              @default(0) // 0-100

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  archivedAt      DateTime?

  // Relations
  organization    Organization     @relation(fields: [orgId], references: [id], onDelete: Cascade)
  owner           User             @relation("ObjectiveOwner", fields: [ownerId], references: [id])
  parent          Objective?       @relation("ObjectiveHierarchy", fields: [parentId], references: [id])
  children        Objective[]      @relation("ObjectiveHierarchy")
  keyResults      KeyResult[]
  updates         ObjectiveUpdate[]

  @@index([orgId, status])
  @@index([ownerId])
  @@index([parentId])
  @@index([endDate])
}

model KeyResult {
  id              String           @id @default(uuid())
  objectiveId     String
  title           String
  description     String?          @db.Text

  // Measurement
  targetValue     Float            // Target value (e.g., 100)
  currentValue    Float            @default(0) // Current value
  startValue      Float            @default(0) // Starting value for delta calculations
  unit            String?          // e.g., "%", "users", "$"

  // Weighting for progress calculation
  weight          Float            @default(1.0) // Relative importance

  // Status
  status          KeyResultStatus  @default(NOT_STARTED)

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  // Relations
  objective       Objective        @relation(fields: [objectiveId], references: [id], onDelete: Cascade)
  progressHistory KeyResultProgress[]

  @@index([objectiveId])
  @@index([status])
}

model KeyResultProgress {
  id              String           @id @default(uuid())
  keyResultId     String
  previousValue   Float
  newValue        Float
  notes           String?          @db.Text

  recordedById    String
  recordedAt      DateTime         @default(now())

  // Relations
  keyResult       KeyResult        @relation(fields: [keyResultId], references: [id], onDelete: Cascade)
  recordedBy      User             @relation("KeyResultProgressRecorder", fields: [recordedById], references: [id])

  @@index([keyResultId, recordedAt])
}

model ObjectiveUpdate {
  id              String           @id @default(uuid())
  objectiveId     String
  content         String           @db.Text // Check-in content (markdown supported)

  // Snapshot at time of update
  progressSnapshot Int?            // Objective progress at time of update

  createdById     String
  createdAt       DateTime         @default(now())

  // Relations
  objective       Objective        @relation(fields: [objectiveId], references: [id], onDelete: Cascade)
  createdBy       User             @relation("ObjectiveUpdateCreator", fields: [createdById], references: [id])

  @@index([objectiveId, createdAt])
  @@index([createdById])
}

// ============================================
// REAL-TIME CHAT (PX-713)
// ============================================

model ChatRoom {
  id              String    @id @default(uuid())
  organizationId  String
  clientId        String    @unique  // One chat room per client
  isActive        Boolean   @default(true)
  lastActivityAt  DateTime  @default(now())
  createdAt       DateTime  @default(now())

  // Relations
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client          Client       @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([organizationId, clientId])
  @@index([isActive, lastActivityAt])
  @@index([organizationId, isActive])
}

// ============================================
// STAFF TRAINING & QUIZZES (PX-704, PX-707)
// ============================================

enum QuizQuestionType {
  SINGLE_CHOICE   // Select one answer
  MULTIPLE_CHOICE // Select all that apply
  FREE_TEXT       // Open-ended response
  SCALE           // 1-10 rating (self-assessment)
  MATCHING        // Match items to categories
  ORDERING        // Put items in sequence
  FILE_UPLOAD     // Upload document/image
}

enum QuizAttemptStatus {
  IN_PROGRESS
  PASSED
  FAILED
}

enum QuizAudience {
  STAFF   // Only for staff training
  CLIENT  // Only for client learning
  BOTH    // Available to both
}

model Quiz {
  id              String        @id @default(uuid())
  organizationId  String
  title           String
  description     String?       @db.Text
  audience        QuizAudience  @default(BOTH)
  passingScore    Int           @default(80) // Percentage required to pass
  maxAttempts     Int?          // Null = unlimited attempts
  isActive        Boolean       @default(true)
  createdById     String
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  archivedAt      DateTime?     // Soft delete

  // Relations
  organization    Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy       User          @relation("QuizCreator", fields: [createdById], references: [id])
  questions       QuizQuestion[]
  attempts        QuizAttempt[]

  @@index([organizationId, isActive])
  @@index([audience])
  @@index([createdById])
}

model QuizQuestion {
  id            String           @id @default(uuid())
  quizId        String
  type          QuizQuestionType
  question      String           @db.Text
  options       Json?            // For choice/matching questions: { choices: [...], pairs?: [...] }
  correctAnswer Json             // Correct answer(s) - format depends on type
  points        Int              @default(1) // Points for correct answer
  order         Int              // Fixed question order
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  // Relations
  quiz          Quiz             @relation(fields: [quizId], references: [id], onDelete: Cascade)
  answers       QuizAnswer[]

  @@index([quizId, order])
}

model QuizAttempt {
  id            String            @id @default(uuid())
  quizId        String
  userId        String
  score         Int?              // Final score percentage (0-100)
  totalPoints   Int?              // Total points earned
  maxPoints     Int?              // Maximum possible points
  status        QuizAttemptStatus @default(IN_PROGRESS)
  startedAt     DateTime          @default(now())
  completedAt   DateTime?

  // Relations
  quiz          Quiz              @relation(fields: [quizId], references: [id], onDelete: Cascade)
  user          User              @relation("QuizAttemptUser", fields: [userId], references: [id])
  answers       QuizAnswer[]

  @@index([quizId, userId])
  @@index([userId, status])
  @@index([startedAt])
}

model QuizAnswer {
  id           String       @id @default(uuid())
  attemptId    String
  questionId   String
  answer       Json         // User's answer - format depends on question type
  isCorrect    Boolean?     // Null for FREE_TEXT/FILE_UPLOAD pending review
  pointsEarned Int?         // Points awarded (null if not yet graded)
  fileUrl      String?      // S3 URL for FILE_UPLOAD answers
  reviewedAt   DateTime?    // When manual review was completed
  reviewedById String?      // Who reviewed (for FREE_TEXT/FILE_UPLOAD)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  // Relations
  attempt      QuizAttempt  @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  question     QuizQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  reviewedBy   User?        @relation("QuizAnswerReviewer", fields: [reviewedById], references: [id])

  @@unique([attemptId, questionId]) // One answer per question per attempt
  @@index([attemptId])
  @@index([questionId])
}

// ============================================
// AUTOMATED CHATBOT INTAKE (PX-702)
// ============================================

enum ChatSessionStatus {
  ACTIVE       // Session in progress
  COMPLETED    // Intake successfully completed
  ABANDONED    // Session abandoned (no activity)
  ESCALATED    // Escalated due to crisis detection
}

model ChatSession {
  id                String            @id @default(uuid())
  organizationId    String
  formId            String
  status            ChatSessionStatus @default(ACTIVE)

  // Client identification (collected during conversation)
  clientPhone       String?
  clientEmail       String?

  // Extracted data from conversation
  extractedData     Json?             // Field slug -> extracted value
  lastQuestionIndex Int               @default(0)  // Track progress through form

  // Handoff tracking
  handoffRequested  Boolean           @default(false)
  handoffUserId     String?           // Case manager who accepted handoff
  handoffRequestedAt DateTime?

  // Crisis detection
  crisisDetected    Boolean           @default(false)
  crisisDetectedAt  DateTime?

  // Session cookie for resume (hashed)
  resumeToken       String?           @unique

  // Completion
  completedAt       DateTime?
  clientId          String?           // Created client after completion

  // Analytics
  dropOffField      String?           // Last field answered before abandonment

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  // Relations
  organization      Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  form              Form              @relation(fields: [formId], references: [id])
  handoffUser       User?             @relation("ChatSessionHandoff", fields: [handoffUserId], references: [id])
  createdClient     Client?           @relation("ChatSessionCreatedClient", fields: [clientId], references: [id])
  messages          ChatMessage[]

  @@index([organizationId, status])
  @@index([organizationId, createdAt])
  @@index([resumeToken])
}

model ChatMessage {
  id          String      @id @default(uuid())
  sessionId   String
  role        String      // "user" | "assistant" | "system"
  content     String      @db.Text
  metadata    Json?       // Additional context (e.g., field being asked, crisis flags)
  createdAt   DateTime    @default(now())

  // Relations
  session     ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, createdAt])
}

// ============================================
// WORKFORCE DEVELOPMENT ADD-ON (PX-711)
// ============================================

enum CredentialStatus {
  ACTIVE     // Credential is valid and current
  EXPIRING   // Within 30 days of expiry
  EXPIRED    // Past expiry date
}

enum PlacementStatus {
  ACTIVE      // Currently employed
  ENDED       // Employment ended normally
  TERMINATED  // Employment terminated
}

model JobPlacement {
  id            String          @id @default(uuid())
  clientId      String
  employerName  String
  jobTitle      String
  hourlyWage    Decimal?        @db.Decimal(10, 2)
  startDate     DateTime
  endDate       DateTime?
  status        PlacementStatus @default(ACTIVE)
  notes         String?         @db.Text
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  // Relations
  client        Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([clientId, status])
  @@index([startDate])
}

model Credential {
  id            String           @id @default(uuid())
  clientId      String
  name          String
  issuingOrg    String?
  issueDate     DateTime?
  expiryDate    DateTime?
  status        CredentialStatus @default(ACTIVE)
  documentUrl   String?          // S3 path to credential document
  notes         String?          @db.Text
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  // Relations
  client        Client           @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([expiryDate, status])
  @@index([status])
}

// ============================================
// INSURANCE ELIGIBILITY VERIFICATION (PX-712)
// ============================================

model ClientInsurance {
  id              String    @id @default(uuid())
  clientId        String
  planName        String
  memberId        String
  groupNumber     String?
  payerCode       String?   // Standard payer ID for clearinghouse
  payerName       String?   // Human-readable payer name
  effectiveDate   DateTime
  terminationDate DateTime?
  isPrimary       Boolean   @default(true)

  // Subscriber information (if different from client)
  subscriberName  String?
  subscriberDob   DateTime?
  subscriberRelation String? // "self", "spouse", "child", "other"

  // Additional plan details
  planType        String?   // "PPO", "HMO", "EPO", "POS", etc.
  planPhone       String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  client          Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  eligibilityChecks EligibilityCheck[]

  @@index([clientId])
  @@index([clientId, isPrimary])
  @@index([memberId, payerCode])
}

model EligibilityCheck {
  id              String    @id @default(uuid())
  clientId        String
  insurancePlanId String?   // Link to ClientInsurance if used
  serviceCode     String    // CPT code or service type code
  serviceName     String?   // Human-readable service name

  // Eligibility result
  isEligible      Boolean

  // Full response data from clearinghouse
  responseData    Json      // Parsed 271 response
  // Structure: {
  //   planName, memberId, groupNumber,
  //   effectiveDate, terminationDate,
  //   copay, deductible, deductibleRemaining,
  //   coinsurance, outOfPocketMax, outOfPocketRemaining,
  //   priorAuthRequired, limitations, exclusions,
  //   rawResponse?: string
  // }

  // Generated documents
  documentUrls    String[]  // S3 URLs to generated PDFs

  // Caching
  checkedAt       DateTime  @default(now())
  expiresAt       DateTime  // 7 days from checkedAt by default

  // API metadata
  requestId       String?   // External API request ID
  providerNpi     String?   // NPI of the checking provider

  createdAt       DateTime  @default(now())

  // Relations
  client          Client         @relation(fields: [clientId], references: [id], onDelete: Cascade)
  insurancePlan   ClientInsurance? @relation(fields: [insurancePlanId], references: [id])

  @@index([clientId, serviceCode])
  @@index([expiresAt])
  @@index([clientId, checkedAt])
  @@index([insurancePlanId])
}

// ============================================
// IN-PERSON RECORDING (PX-703)
// ============================================

enum ConsentMethod {
  DIGITAL     // Client signs on device
  VERBAL      // First 10 seconds of recording captures verbal consent
  PRE_SIGNED  // Reference to existing consent document
}

model InPersonRecording {
  id                String        @id @default(uuid())
  organizationId    String
  clientId          String
  userId            String        // Case manager who recorded

  // Recording storage
  recordingUrl      String?       // S3 key: in-person/{orgId}/{recordingId}.webm
  duration          Int?          // Duration in seconds

  // Transcription and extraction
  transcriptText    String?       @db.Text
  extractedData     Json?         // Field slug -> extracted value (same as Call)
  confidenceScores  Json?         // Field slug -> confidence score

  // Processing status
  processingStatus  ProcessingStatus @default(PENDING)
  processingError   String?
  processedAt       DateTime?

  // Consent tracking
  consentMethod     ConsentMethod
  consentRecordedAt DateTime      // When consent was captured
  consentSignature  String?       // S3 key to signature image (for DIGITAL)
  consentDocumentId String?       // Reference to consent document (for PRE_SIGNED)

  // Form linkage (optional - for extraction)
  formIds           String[]      @default([])

  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  // Relations
  organization      Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client            Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  user              User          @relation(fields: [userId], references: [id])

  @@index([organizationId])
  @@index([clientId])
  @@index([userId])
  @@index([processingStatus])
  @@index([createdAt])
}
